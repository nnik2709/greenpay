import{p as W,s as u,h as re,u as oe,v as ne,r as l,F as T,f as P,U,j as e,m as le,B as i,a7 as ie,I as m,D as B,i as G,k as R,l as H,n as K,o as L}from"./index-f386841f.js";import{H as z}from"./hash-110faeb3.js";import{S}from"./send-f7a2142e.js";import{D as k}from"./dollar-sign-54a6a05d.js";import{X}from"./x-circle-a9f0bd3e.js";import{C as Z}from"./calendar-a622c72a.js";import{F as ce}from"./filter-df158437.js";const de=W("ArrowRightCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"m12 16 4-4-4-4",key:"1i9zcv"}]]),ue=W("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z",key:"y3tblf"}]]),me=async()=>{try{const{data:a,error:s}=await u.from("quotations").select("*").order("created_at",{ascending:!1});if(s)throw s;return a}catch(a){return console.error("Error loading quotations:",a),[]}};async function pe(a){try{const{data:s,error:r}=await u.from("quotations").update({status:"sent",sent_at:new Date().toISOString()}).eq("id",a).select().single();if(r)throw r;return{success:!0,data:s}}catch(s){return console.error("Error marking quotation as sent:",s),{success:!1,error:s.message}}}async function xe(a,s){try{const{data:r,error:c}=await u.from("quotations").update({status:"approved",approved_by:s,approved_at:new Date().toISOString()}).eq("id",a).select().single();if(c)throw c;return{success:!0,data:r}}catch(r){return console.error("Error approving quotation:",r),{success:!1,error:r.message}}}async function he(a,s){try{const{data:r,error:c}=await u.from("quotations").select("*").eq("id",a).single();if(c)throw c;if(r.status!=="approved")throw new Error("Only approved quotations can be converted");const p=`BATCH-${Date.now()}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,n=r.total_amount,A=r.discount_amount||0,D=r.amount_after_discount||n-A,F=parseFloat(s.collectedAmount)-D,x=[],y=[];for(let g=0;g<r.number_of_passports;g++){const C=`VCH-${Date.now()}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,v={voucher_code:C,passport_number:"PENDING",company_name:r.company_name,quantity:1,amount:r.amount_per_passport,payment_method:s.paymentMethod,valid_from:new Date().toISOString(),valid_until:r.valid_until,quotation_id:a,batch_id:p,created_by:s.createdBy};x.push({...v,voucherCode:C}),y.push(v)}const{data:h,error:o}=await u.from("corporate_vouchers").insert(y).select();if(o)throw o;const{error:N}=await u.from("quotations").update({status:"converted",converted_at:new Date().toISOString()}).eq("id",a);if(N)throw N;return{success:!0,batchId:p,vouchers:h,quotation:r}}catch(r){return console.error("Error converting quotation:",r),{success:!1,error:r.message}}}async function ge(){try{const{data:a,error:s}=await u.from("quotation_statistics").select("*").single();if(s)throw s;return a}catch(a){return console.error("Error fetching quotation statistics:",a),{draft_count:0,sent_count:0,approved_count:0,converted_count:0,expired_count:0,rejected_count:0,total_count:0,converted_value:0,total_value:0,conversion_rate:0}}}function ve(a){return!(!a||a.status!=="approved"||a.converted_at||new Date().toISOString().split("T")[0]>a.valid_until)}function be(a){return!(!a||!["sent","pending"].includes(a.status)||a.approved_at)}const J=({title:a,value:s,icon:r,color:c,bgColor:p})=>{const n=r;return e.jsxs("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl p-4 shadow-lg border border-emerald-100 flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-full ${p}`,children:e.jsx(n,{className:`w-6 h-6 ${c}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:a}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:s})]})]})},Se=()=>{var O,V;const a=re(),{toast:s}=oe(),{user:r}=ne(),[c,p]=l.useState([]),[n,A]=l.useState(null),[D,E]=l.useState(!0),[F,x]=l.useState(!1),[y,h]=l.useState(!1),[o,N]=l.useState(null),[g,C]=l.useState(""),[v,Y]=l.useState(""),[Q,q]=l.useState(!1),[I,M]=l.useState(!1),[$,ee]=l.useState("CASH"),[b,te]=l.useState("");l.useEffect(()=>{w(),_()},[]);const w=async()=>{try{E(!0);const t=await me();p(t)}catch(t){console.error("Error loading quotations:",t),s({variant:"destructive",title:"Error",description:"Failed to load quotations"})}finally{E(!1)}},_=async()=>{try{const t=await ge();A(t)}catch(t){console.error("Error loading statistics:",t)}},se=n?[{title:"Total",value:n.total_count||"0",icon:z,color:"text-blue-600",bgColor:"bg-blue-100"},{title:"Draft",value:n.draft_count||"0",icon:T,color:"text-gray-600",bgColor:"bg-gray-100"},{title:"Sent",value:n.sent_count||"0",icon:S,color:"text-purple-600",bgColor:"bg-purple-100"},{title:"Approved",value:n.approved_count||"0",icon:P,color:"text-green-600",bgColor:"bg-green-100"},{title:"Converted",value:n.converted_count||"0",icon:k,color:"text-yellow-600",bgColor:"bg-yellow-100"},{title:"Expired",value:n.expired_count||"0",icon:X,color:"text-red-600",bgColor:"bg-red-100"}]:[{title:"Total",value:"0",icon:z,color:"text-blue-600",bgColor:"bg-blue-100"},{title:"Draft",value:"0",icon:T,color:"text-gray-600",bgColor:"bg-gray-100"},{title:"Sent",value:"0",icon:S,color:"text-purple-600",bgColor:"bg-purple-100"},{title:"Approved",value:"0",icon:P,color:"text-green-600",bgColor:"bg-green-100"},{title:"Converted",value:"0",icon:k,color:"text-yellow-600",bgColor:"bg-yellow-100"},{title:"Expired",value:"0",icon:X,color:"text-red-600",bgColor:"bg-red-100"}],ae=n?[{title:"Total Value",value:`PGK ${(n.total_value||0).toFixed(2)}`,icon:k,color:"text-emerald-600",bgColor:"bg-emerald-100"},{title:"Converted Value",value:`PGK ${(n.converted_value||0).toFixed(2)}`,icon:U,color:"text-indigo-600",bgColor:"bg-indigo-100"},{title:"Conversion Rate",value:`${(n.conversion_rate||0).toFixed(1)}%`,icon:Z,color:"text-pink-600",bgColor:"bg-pink-100"}]:[{title:"Total Value",value:"PGK 0.00",icon:k,color:"text-emerald-600",bgColor:"bg-emerald-100"},{title:"Total Vouchers",value:"0",icon:U,color:"text-indigo-600",bgColor:"bg-indigo-100"},{title:"This Month",value:"0",icon:Z,color:"text-pink-600",bgColor:"bg-pink-100"}];return e.jsx("main",{children:e.jsxs(le.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.5},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent",children:"Quotations Management"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(i,{variant:"outline",onClick:()=>x(!0),children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"Send Quotation"]}),e.jsxs(i,{onClick:()=>a("/quotations/create"),className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Create New Quotation"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:se.map(t=>e.jsx(J,{...t},t.title))}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:ae.map(t=>e.jsx(J,{...t},t.title))}),e.jsxs("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-emerald-100",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4",children:[e.jsx(m,{placeholder:"QUOTATION #, CLIENT NAME, EMAIL",className:"lg:col-span-2"}),e.jsx(m,{placeholder:"Status: All Status"}),e.jsx(m,{type:"date",placeholder:"Start Date"}),e.jsx(m,{type:"date",placeholder:"End Date"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(i,{variant:"outline",className:"w-full",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Filter"]}),e.jsx(i,{variant:"ghost",className:"w-full",children:"Clear"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-slate-600",children:[e.jsx("thead",{className:"text-xs text-slate-700 uppercase bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Quotation #"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Client"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Subject"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Vouchers"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Amount"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Due Date"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Valid Until"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Created"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Actions"})]})}),e.jsx("tbody",{children:D?e.jsx("tr",{children:e.jsx("td",{colSpan:"10",className:"text-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto"})})}):c.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:"10",className:"text-center py-16",children:[e.jsx(T,{className:"mx-auto h-12 w-12 text-slate-400"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-slate-800",children:"No quotations found"}),e.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Create your first quotation to get started."}),e.jsx(i,{onClick:()=>a("/quotations/create"),className:"mt-4 bg-emerald-600 hover:bg-emerald-700 text-white",children:"Create Quotation"})]})}):c.map(t=>{var d,f;return e.jsxs("tr",{className:"bg-white border-b hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4 font-medium text-slate-900",children:t.quotation_number}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{children:t.company_name}),e.jsx("div",{className:"text-xs text-slate-500",children:t.contact_email})]}),e.jsx("td",{className:"px-6 py-4",children:t.notes||"-"}),e.jsx("td",{className:"px-6 py-4 text-right",children:t.number_of_passports}),e.jsxs("td",{className:"px-6 py-4 text-right",children:["PGK ",(d=t.total_amount)==null?void 0:d.toFixed(2)]}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${t.status==="draft"?"bg-gray-100 text-gray-700":t.status==="sent"?"bg-purple-100 text-purple-700":t.status==="approved"?"bg-green-100 text-green-700":t.status==="converted"?"bg-yellow-100 text-yellow-700":t.status==="rejected"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`,children:(f=t.status)==null?void 0:f.toUpperCase()})}),e.jsx("td",{className:"px-6 py-4",children:t.due_date||"-"}),e.jsx("td",{className:"px-6 py-4",children:new Date(t.valid_until).toLocaleDateString()}),e.jsx("td",{className:"px-6 py-4 text-xs text-slate-500",children:new Date(t.created_at).toLocaleDateString()}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[(t.status==="draft"||t.status==="pending")&&!t.sent_at&&e.jsxs(i,{size:"sm",variant:"outline","data-testid":`quotation-mark-sent-${t.id}`,onClick:async()=>{const j=await pe(t.id);j.success?(s({title:"Quotation Marked as Sent"}),w(),_()):s({variant:"destructive",title:"Error",description:j.error})},children:[e.jsx(S,{className:"w-3 h-3 mr-1"}),"Mark Sent"]}),be(t)&&e.jsxs(i,{size:"sm",variant:"outline",className:"border-green-500 text-green-600 hover:bg-green-50","data-testid":`quotation-approve-${t.id}`,onClick:async()=>{const j=await xe(t.id,r==null?void 0:r.id);j.success?(s({title:"Quotation Approved!"}),w(),_()):s({variant:"destructive",title:"Error",description:j.error})},children:[e.jsx(ue,{className:"w-3 h-3 mr-1"}),"Approve"]}),ve(t)&&e.jsxs(i,{size:"sm",className:"bg-emerald-600 hover:bg-emerald-700","data-testid":`quotation-convert-${t.id}`,onClick:()=>{N(t),h(!0)},children:[e.jsx(de,{className:"w-3 h-3 mr-1"}),"Convert"]}),e.jsx(i,{size:"sm",variant:"ghost","data-testid":`quotation-view-${t.id}`,onClick:()=>{s({title:"View quotation",description:"Quotation details view coming soon"})},children:"View"})]})})]},t.id)})})]})}),e.jsxs("p",{className:"text-sm text-slate-500 mt-4 text-center",children:["Showing all ",c.length," quotation",c.length!==1?"s":""]})]}),e.jsx(B,{open:y,onOpenChange:h,children:e.jsxs(G,{children:[e.jsxs(R,{children:[e.jsx(H,{children:"Convert Quotation to Voucher Batch"}),e.jsxs(K,{children:["Convert approved quotation to corporate voucher batch. This will generate ",o==null?void 0:o.number_of_passports," vouchers."]})]}),o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-slate-600",children:"Company:"}),e.jsx("span",{className:"text-sm font-semibold",children:o.company_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-slate-600",children:"Vouchers:"}),e.jsx("span",{className:"text-sm font-semibold",children:o.number_of_passports})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-slate-600",children:"Total Amount:"}),e.jsxs("span",{className:"text-sm font-semibold",children:["PGK ",(O=o.total_amount)==null?void 0:O.toFixed(2)]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Payment Method"}),e.jsxs("select",{value:$,onChange:t=>ee(t.target.value),className:"w-full mt-1 px-3 py-2 border border-slate-300 rounded-md","data-testid":"conversion-payment-method",children:[e.jsx("option",{value:"CASH",children:"Cash"}),e.jsx("option",{value:"CARD",children:"Card"}),e.jsx("option",{value:"BANK TRANSFER",children:"Bank Transfer"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Collected Amount (PGK)"}),e.jsx(m,{type:"number",step:"0.01",value:b,onChange:t=>te(t.target.value),placeholder:(V=o.total_amount)==null?void 0:V.toFixed(2),"data-testid":"conversion-collected-amount"})]}),parseFloat(b)>(o.total_amount||0)&&e.jsxs("div",{className:"text-sm text-emerald-600",children:["Change: PGK ",(parseFloat(b)-(o.total_amount||0)).toFixed(2)]})]})]}),e.jsxs(L,{children:[e.jsx(i,{variant:"outline",onClick:()=>h(!1),disabled:I,children:"Cancel"}),e.jsx(i,{onClick:async()=>{var t;if(!b||parseFloat(b)<((o==null?void 0:o.total_amount)||0)){s({variant:"destructive",title:"Invalid Amount",description:"Collected amount must be at least the total amount"});return}M(!0);try{const d=await he(o.id,{paymentMethod:$,collectedAmount:b,createdBy:r==null?void 0:r.id});d.success?(s({title:"Conversion Successful!",description:`Generated ${(t=d.vouchers)==null?void 0:t.length} vouchers in batch ${d.batchId}`}),h(!1),w(),_(),a("/purchases/corporate-exit-pass")):s({variant:"destructive",title:"Conversion Failed",description:d.error})}catch(d){s({variant:"destructive",title:"Error",description:d.message})}finally{M(!1)}},disabled:I,"data-testid":"conversion-confirm-button",children:I?"Converting...":"Convert to Vouchers"})]})]})}),e.jsx(B,{open:F,onOpenChange:x,children:e.jsxs(G,{children:[e.jsxs(R,{children:[e.jsx(H,{children:"Send Quotation"}),e.jsx(K,{children:"Enter the quotation ID and recipient email address."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 mb-1",children:"Quotation ID"}),e.jsx(m,{value:g,onChange:t=>C(t.target.value),placeholder:"e.g. 1024"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 mb-1",children:"Recipient Email"}),e.jsx(m,{type:"email",value:v,onChange:t=>Y(t.target.value),placeholder:"client@example.com"})]})]}),e.jsxs(L,{children:[e.jsx(i,{variant:"outline",onClick:()=>x(!1),disabled:Q,children:"Cancel"}),e.jsx(i,{disabled:Q,onClick:async()=>{if(!g||!v){s({variant:"destructive",title:"Missing data",description:"Provide quotation ID and recipient email."});return}q(!0);try{const{data:t,error:d}=await u.from("quotations").select("id").eq("quotation_number",g).single();if(d||!t)throw new Error("Quotation not found. Please check the quotation number.");const{error:f}=await u.functions.invoke("send-quotation",{body:{quotationId:t.id,email:v}});if(f)throw f;await u.from("quotations").update({status:"sent",sent_at:new Date().toISOString()}).eq("id",t.id),s({title:"Quotation sent",description:"Email has been queued for delivery."}),x(!1)}catch(t){s({variant:"destructive",title:"Send failed",description:(t==null?void 0:t.message)||"Unable to send quotation."})}finally{q(!1)}},children:Q?"Sendingâ€¦":"Send"})]})]})})]})})};export{Se as default};

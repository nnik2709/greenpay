import{u as ae,r as a,j as e,B as i,X as he,e as re,A as xe,m as h,f as ue,g as pe,h as ge,I as F,C as q,a as Y,b as Q,d as K,D as U,i as V,k as $,l as Z,n as L,o as ee,s as z,F as fe}from"./index-f386841f.js";import{g as je,s as be}from"./passportsService-036110f9.js";import{C as G,H as ve}from"./html5-qrcode-scanner-0b6f47c5.js";import{S as Ne}from"./search-0da320f8.js";import{U as Se}from"./user-plus-0adf7eae.js";import{S as ye}from"./scan-line-463d579a.js";import{H as we}from"./hash-110faeb3.js";import{G as Ce}from"./globe-21edfe06.js";import{U as ke}from"./user-806b4eaa.js";import{C as se}from"./calendar-a622c72a.js";const Ee=({onScanSuccess:t,onClose:v})=>{const{toast:c}=ae(),[d,x]=a.useState(!1),[u,p]=a.useState(null),[r,N]=a.useState(null),[f,o]=a.useState(!1);a.useRef(null);const j=n=>{try{const l=n.replace(/\s/g,"");if(l.length<88)throw new Error("MRZ length is too short.");const E=l.substring(0,44),g=l.substring(44,88),I=E.substring(5).split("<<"),y=I[0].replace(/</g," ").trim(),P=I.slice(1).join(" ").replace(/</g," ").trim(),A=g.substring(0,9).replace(/</g,"").trim(),R=g.substring(10,13),w=g.substring(13,19);let b=parseInt(w.substring(0,2),10);b+=b>new Date().getFullYear()%100?1900:2e3;const O=`${b}-${w.substring(2,4)}-${w.substring(4,6)}`,D=g.substring(20,21),M=g.substring(21,27);let C=parseInt(M.substring(0,2),10);C+=C>50?1900:2e3;const T=`${C}-${M.substring(2,4)}-${M.substring(4,6)}`;return{passportNumber:A,surname:y,givenName:P,nationality:R,dateOfBirth:O,sex:D==="M"?"Male":"Female",dateOfExpiry:T}}catch(l){throw new Error("Invalid MRZ format: "+l.message)}},B=a.useCallback(async n=>{if(!f){o(!0),N(null);try{if(n.startsWith("P<")){const l=j(n);N({type:"success",data:l,message:"Passport MRZ scanned successfully!"}),c({title:"Scan Successful",description:`Passport details for ${l.givenName} ${l.surname} have been extracted.`}),setTimeout(()=>{t(l)},1500)}else throw new Error("Not a valid passport MRZ code. Please scan the bottom of the passport.")}catch(l){N({type:"error",message:l.message}),c({title:"Scan Failed",description:l.message,variant:"destructive"})}finally{o(!1)}}},[f,t,c]),S=a.useCallback(n=>{(n.includes("Permission denied")||n.includes("NotAllowedError"))&&(c({title:"Camera Permission Denied",description:"Please allow camera access and try again.",variant:"destructive"}),x(!1))},[c]),k=()=>{if(d)return;if(!(window.isSecureContext||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.protocol==="https:")){c({title:"Camera Not Available",description:"Camera access requires HTTPS. Please use manual entry or visit via HTTPS.",variant:"destructive"});return}x(!0),N(null);const l=new ve("mrz-scanner",{fps:10,qrbox:300,rememberLastUsedCamera:!0,showTorchButtonIfSupported:!0},{verbose:!1,formatsToSupport:void 0,useBarCodeDetectorIfSupported:!0,showZoomSliderIfSupported:!0,defaultZoomValueIfSupported:2});l.render(B,S),p(l)},H=()=>{u&&(u.clear().catch(n=>console.error("Failed to clear scanner",n)),p(null)),x(!1)};return a.useEffect(()=>()=>{u&&u.clear().catch(n=>console.error("Failed to clear scanner",n))},[u]),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(G,{className:"w-6 h-6 text-blue-600 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-blue-900 mb-1",children:"How to Scan"}),e.jsxs("ul",{className:"text-blue-800 text-sm space-y-1 list-disc list-inside",children:[e.jsx("li",{children:"Position the passport so the MRZ (bottom lines) are clearly visible"}),e.jsx("li",{children:"Ensure good lighting and hold the passport steady"}),e.jsx("li",{children:"The scanner will automatically detect and parse the MRZ"}),e.jsx("li",{children:"You'll be redirected to create a passport with the scanned data"})]})]})]})}),e.jsx("div",{className:"flex justify-center gap-4",children:d?e.jsxs(i,{onClick:H,variant:"destructive",disabled:f,children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Stop Scanning"]}):e.jsxs(i,{onClick:k,className:"bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700",disabled:f,children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Start Camera Scan"]})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{id:"mrz-scanner",className:"w-full min-h-[300px] bg-slate-100 rounded-lg flex items-center justify-center",children:!d&&e.jsxs("div",{className:"text-center text-slate-500",children:[e.jsx(G,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:'Click "Start Camera Scan" to begin'})]})}),f&&e.jsx("div",{className:"absolute inset-0 bg-white/80 flex items-center justify-center rounded-lg",children:e.jsxs("div",{className:"text-center",children:[e.jsx(re,{className:"w-8 h-8 animate-spin text-emerald-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Processing scan..."})]})})]}),e.jsx(xe,{children:r&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:`p-4 rounded-lg border ${r.type==="success"?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[r.type==="success"?e.jsx(ue,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}):e.jsx(pe,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:`font-medium ${r.type==="success"?"text-green-800":"text-red-800"}`,children:r.message}),r.data&&e.jsxs("div",{className:"mt-2 text-sm text-green-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",r.data.givenName," ",r.data.surname]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Passport:"})," ",r.data.passportNumber]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Nationality:"})," ",r.data.nationality]})]})]})]})})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(i,{variant:"outline",onClick:v,children:"Cancel"}),(r==null?void 0:r.type)==="success"&&e.jsx(i,{onClick:()=>t(r.data),className:"bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700",children:"Use Scanned Data"})]})]})},te=({passport:t,index:v,selectedIds:c,setSelectedIds:d,openSendEmail:x})=>e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:v*.05},whileHover:{scale:1.02,y:-4},children:e.jsxs(q,{className:`overflow-hidden card-hover border-slate-200 ${c.includes(t.id)?"ring-2 ring-emerald-300":""}`,children:[e.jsx(Y,{className:"bg-gradient-to-r from-emerald-50 to-teal-50 border-b border-emerald-100",children:e.jsxs(Q,{className:"flex items-center gap-3 text-lg font-semibold text-slate-800",children:[e.jsx(fe,{className:"text-emerald-600 w-5 h-5"}),t.given_name||t.givenName," ",t.surname]})}),e.jsxs(K,{className:"p-5 space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"rounded border-slate-300",checked:c.includes(t.id),onChange:u=>{d(p=>u.target.checked?[...p,t.id]:p.filter(r=>r!==t.id))}}),e.jsx("span",{className:"text-slate-600",children:"Select"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Passport No:"})," ",t.passport_number||t.passportNumber]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Nationality:"})," ",t.nationality]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Sex:"})," ",t.sex]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"DOB:"})," ",t.date_of_birth?new Date(t.date_of_birth).toLocaleDateString():t.dob]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Expiry:"})," ",t.date_of_expiry?new Date(t.date_of_expiry).toLocaleDateString():t.dateOfExpiry]}),e.jsx("div",{className:"pt-2",children:e.jsx(i,{size:"sm",variant:"outline",onClick:()=>x(t),children:"Send Voucher Email"})})]})]})}),He=()=>{const{toast:t}=ae(),v=ge(),[c,d]=a.useState(!1),[x,u]=a.useState(""),[p,r]=a.useState([]),[N,f]=a.useState(!1),[o,j]=a.useState([]),[B,S]=a.useState(!1),[k,H]=a.useState(""),[n,l]=a.useState(""),[E,g]=a.useState(!1),[I,y]=a.useState(!1),[P,A]=a.useState(null),[R,w]=a.useState(""),[b,O]=a.useState(!1),[D,M]=a.useState([]),[C,T]=a.useState(!0);a.useEffect(()=>{le()},[]);const le=async()=>{T(!0);try{const s=await je();M(s)}catch(s){console.error("Error loading passports:",s),t({variant:"destructive",title:"Error",description:"Failed to load passports."})}finally{T(!1)}},W=a.useMemo(()=>({subject:"Your PNG Green Fee Voucher",html:`<p>Dear traveller,</p>
<p>Thank you for your payment. Your PNG Green Fee voucher is now ready.</p>
<p><strong>Voucher Code:</strong> {{VOUCHER_CODE}}<br/>
<strong>Passport No:</strong> {{PASSPORT_NUMBER}}<br/>
<strong>Issued On:</strong> {{ISSUE_DATE}}</p>
<p>Please keep this voucher for airport checks. For any questions, reply to this email.</p>
<p>Kind regards,<br/>PNG Green Fees Team</p>`}),[]),X=s=>{A(s),w(""),y(!0)},ne=s=>P?s.replaceAll("{{VOUCHER_CODE}}",P.voucherCode||"—").replaceAll("{{PASSPORT_NUMBER}}",P.passportNumber||"—").replaceAll("{{ISSUE_DATE}}",new Date().toLocaleDateString()):s,ie=async()=>{if(!R){t({variant:"destructive",title:"Recipient required",description:"Enter a recipient email."});return}O(!0);try{const{data:s}=await z.from("email_templates").select("subject, html, body").eq("template_key","individual_voucher").maybeSingle(),m=(s==null?void 0:s.subject)||W.subject,de=(s==null?void 0:s.body)??(s==null?void 0:s.html)??W.html,me=ne(de),{error:J}=await z.functions.invoke("send-email",{body:{to:R,subject:m,html:me,templateId:"individual_voucher"}});if(J)throw J;t({title:"Email sent",description:"Voucher email sent to recipient."}),y(!1)}catch(s){t({variant:"destructive",title:"Send failed",description:(s==null?void 0:s.message)||"Unable to send email."})}finally{O(!1)}},ce=async s=>{if(s.preventDefault(),f(!0),!x.trim()){r([]),t({variant:"destructive",title:"Search field is empty",description:"Please enter a passport number or name to search."});return}try{const m=await be(x.trim());r(m),j([]),t({title:"Search Complete",description:`${m.length} passport(s) found.`})}catch(m){console.error("Search error:",m),t({variant:"destructive",title:"Search Failed",description:"Failed to search passports."})}},oe=()=>{v("/passports/create")},_={hidden:{opacity:0,y:20},visible:{opacity:1,y:0}};return e.jsxs(e.Fragment,{children:[e.jsxs(h.div,{className:"max-w-4xl mx-auto",children:[e.jsxs(h.div,{variants:_,className:"text-center mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 bg-clip-text text-transparent mb-3",children:"Passport Management"}),e.jsx("p",{className:"text-slate-600 text-lg",children:"Search, create, or scan passports to begin your journey."})]}),e.jsxs(h.div,{variants:_,className:"glass-effect rounded-3xl p-10 space-y-10",children:[e.jsxs("form",{onSubmit:ce,children:[e.jsx("label",{htmlFor:"passport-search",className:"block text-xl font-semibold text-slate-800 mb-4",children:"Search for a Passport"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(Ne,{className:"absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-6 h-6"}),e.jsx(F,{id:"passport-search",placeholder:"Enter Passport Number or Name...",className:"pl-14 h-16 text-lg border-slate-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all rounded-xl",value:x,onChange:s=>u(s.target.value)})]}),e.jsx(h.div,{whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx(i,{type:"submit",size:"lg",className:"h-16 px-8 text-lg font-semibold bg-gradient-to-r from-emerald-600 via-emerald-500 to-teal-600 text-white shadow-lg hover:shadow-2xl transition-all rounded-xl",children:"Search"})})]})]}),e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("div",{className:"flex-grow border-t border-slate-300"}),e.jsx("span",{className:"flex-shrink mx-6 text-slate-500 font-medium",children:"Or"}),e.jsx("div",{className:"flex-grow border-t border-slate-300"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(h.div,{whileHover:{scale:1.03,y:-4},whileTap:{scale:.98},children:e.jsxs(i,{onClick:oe,variant:"outline",className:"w-full h-28 text-lg font-semibold flex items-center justify-center gap-3 border-2 border-emerald-300 text-emerald-700 hover:bg-emerald-50 hover:text-emerald-800 hover:border-emerald-400 rounded-2xl transition-all shadow-md hover:shadow-xl",children:[e.jsx(Se,{className:"w-7 h-7"}),"Create New Passport"]})}),e.jsx(h.div,{whileHover:{scale:1.03,y:-4},whileTap:{scale:.98},children:e.jsxs(i,{onClick:()=>d(!0),variant:"outline",className:"w-full h-28 text-lg font-semibold flex items-center justify-center gap-3 border-2 border-teal-300 text-teal-700 hover:bg-teal-50 hover:text-teal-800 hover:border-teal-400 rounded-2xl transition-all shadow-md hover:shadow-xl",children:[e.jsx(ye,{className:"w-7 h-7"}),"Scan with Camera"]})})]})]}),N&&e.jsx(h.div,{variants:_,initial:"hidden",animate:"visible",className:"mt-10",children:e.jsxs(q,{className:"glass-effect border-slate-200",children:[e.jsx(Y,{className:"pb-4",children:e.jsx(Q,{className:"text-2xl font-semibold text-slate-800",children:"Search Results"})}),e.jsx(K,{children:p.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:["Selected: ",o.length]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{size:"sm",variant:"outline",onClick:()=>S(!0),disabled:o.length===0,children:"Send Bulk Email"}),e.jsx(i,{size:"sm",variant:"ghost",onClick:()=>j([]),disabled:o.length===0,children:"Clear Selection"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:p.map((s,m)=>e.jsx(te,{passport:s,index:m,selectedIds:o,setSelectedIds:j,openSendEmail:X},s.id))})]}):e.jsx("p",{className:"text-center text-slate-500 py-8",children:"No passports found matching your search."})})]})}),e.jsx(h.div,{variants:_,initial:"hidden",animate:"visible",className:"mt-10",children:e.jsxs(q,{className:"glass-effect border-slate-200",children:[e.jsx(Y,{className:"pb-4",children:e.jsxs(Q,{className:"text-2xl font-semibold text-slate-800 flex items-center justify-between",children:[e.jsx("span",{children:"All Passports"}),e.jsx("span",{className:"text-base font-normal text-slate-500",children:C?"Loading...":`${D.length} total`})]})}),e.jsx(K,{children:C?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(re,{className:"w-8 h-8 animate-spin text-emerald-600"})}):D.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:D.map((s,m)=>e.jsx(te,{passport:s,index:m,selectedIds:o,setSelectedIds:j,openSendEmail:X},s.id))}):e.jsx("p",{className:"text-center text-slate-500 py-8",children:"No passports found. Create your first passport to get started."})})]})})]}),e.jsx(U,{open:c,onOpenChange:d,children:e.jsxs(V,{className:"max-w-2xl",children:[e.jsxs($,{children:[e.jsx(Z,{children:"Scan Passport MRZ"}),e.jsx(L,{children:"Use your camera to scan the Machine Readable Zone (MRZ) at the bottom of the passport to automatically fill in passport details."})]}),e.jsx(Ee,{onScanSuccess:s=>{v("/passports/create",{state:{prefillData:s,fromScan:!0}}),d(!1)},onClose:()=>d(!1)})]})}),e.jsx(U,{open:I,onOpenChange:y,children:e.jsxs(V,{children:[e.jsxs($,{children:[e.jsx(Z,{children:"Send Voucher Email"}),e.jsx(L,{children:"Send the voucher to the traveller’s email address."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm text-slate-600",children:"Recipient Email"}),e.jsx(F,{type:"email",placeholder:"traveller@example.com",value:R,onChange:s=>w(s.target.value)})]}),e.jsxs(ee,{children:[e.jsx(i,{variant:"outline",onClick:()=>y(!1),disabled:b,children:"Cancel"}),e.jsx(i,{onClick:ie,disabled:b,children:b?"Sending…":"Send Email"})]})]})}),e.jsx(U,{open:B,onOpenChange:S,children:e.jsxs(V,{children:[e.jsxs($,{children:[e.jsx(Z,{children:"Send Bulk Voucher Emails"}),e.jsxs(L,{children:[o.length," selected passport(s) will be included."]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 mb-1",children:"Recipient Email"}),e.jsx(F,{type:"email",value:k,onChange:s=>H(s.target.value),placeholder:"recipient@example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 mb-1",children:"Message (optional)"}),e.jsx(F,{value:n,onChange:s=>l(s.target.value),placeholder:"Short message to include"})]})]}),e.jsxs(ee,{children:[e.jsx(i,{variant:"outline",onClick:()=>S(!1),disabled:E,children:"Cancel"}),e.jsx(i,{disabled:E||o.length===0,onClick:async()=>{if(!k){t({variant:"destructive",title:"Recipient required",description:"Enter a recipient email."});return}g(!0);try{const{error:s}=await z.functions.invoke("send-bulk-passport-vouchers",{body:{passportIds:o,email:k,message:n||void 0}});if(s)throw s;t({title:"Bulk email queued",description:"Vouchers will be generated and emailed."}),S(!1),j([])}catch(s){t({variant:"destructive",title:"Bulk send failed",description:(s==null?void 0:s.message)||"Unable to send bulk vouchers."})}finally{g(!1)}},children:E?"Sending…":"Send Bulk Email"})]})]})})]})};export{He as default};

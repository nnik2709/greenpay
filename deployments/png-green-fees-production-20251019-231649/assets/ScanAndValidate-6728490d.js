import{p as X,u as G,r as i,j as e,m as x,A as C,C as g,d as f,B as D,I as W,e as J,a as I,b as $,g as ee,s as A,F as M,f as se}from"./index-f386841f.js";import{H as te,C as H}from"./html5-qrcode-scanner-0b6f47c5.js";import{Q as ae}from"./qr-code-f7e195e1.js";import{H as q}from"./hash-110faeb3.js";import{U as _}from"./user-806b4eaa.js";import{C as U}from"./calendar-a622c72a.js";import{X as re}from"./x-circle-a9f0bd3e.js";const ne=X("Keyboard",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",ry:"2",key:"15u882"}],["path",{d:"M6 8h.001",key:"1ej0i3"}],["path",{d:"M10 8h.001",key:"1x2st2"}],["path",{d:"M14 8h.001",key:"1vkmyp"}],["path",{d:"M18 8h.001",key:"kfsenl"}],["path",{d:"M8 12h.001",key:"1sjpby"}],["path",{d:"M12 12h.001",key:"al75ts"}],["path",{d:"M16 12h.001",key:"931bgk"}],["path",{d:"M7 16h10",key:"wp8him"}]]),he=()=>{const{toast:d}=G(),[S,y]=i.useState(""),[F,j]=i.useState(null),[T,k]=i.useState(!1),[u,h]=i.useState(!1),[B,P]=i.useState(!1),R=i.useRef(null),V=i.useRef(0),n=i.useRef(null);i.useEffect(()=>{n.current=new(window.AudioContext||window.webkitAudioContext)},[]);const Q=async()=>{if(n.current)try{n.current.state==="suspended"&&await n.current.resume();const s=n.current.createOscillator(),t=n.current.createGain();s.connect(t),t.connect(n.current.destination),s.frequency.value=800,s.type="sine",t.gain.setValueAtTime(.3,n.current.currentTime),t.gain.exponentialRampToValueAtTime(.01,n.current.currentTime+.2),s.start(n.current.currentTime),s.stop(n.current.currentTime+.2)}catch(s){console.error("Beep sound error:",s)}},L=s=>{try{const t=s.replace(/\s/g,"");if(t.length<88)throw new Error("MRZ length is too short.");const a=t.substring(0,44),r=t.substring(44,88),o=a.substring(5).split("<<"),c=o[0].replace(/</g," ").trim(),l=o.slice(1).join(" ").replace(/</g," ").trim(),v=r.substring(0,9).replace(/</g,"").trim(),E=r.substring(10,13),m=r.substring(13,19);let p=parseInt(m.substring(0,2),10);p+=p>new Date().getFullYear()%100?1900:2e3;const Y=`${p}-${m.substring(2,4)}-${m.substring(4,6)}`,z=r.substring(20,21),b=r.substring(21,27);let N=parseInt(b.substring(0,2),10);N+=N>50?1900:2e3;const K=`${N}-${b.substring(2,4)}-${b.substring(4,6)}`;return{type:"passport",status:"success",data:{passportNumber:v,surname:c,givenName:l,nationality:E,dob:Y,sex:z==="M"?"Male":"Female",dateOfExpiry:K},message:"Passport MRZ parsed successfully."}}catch{return{type:"error",status:"error",message:"Invalid MRZ format."}}},Z=async s=>{try{console.log("Validating voucher code:",s.trim());const{data:t,error:a}=await A.from("individual_purchases").select("*").eq("voucher_code",s.trim()).maybeSingle();console.log("Individual query result:",{individualData:t,individualError:a});const{data:r,error:o}=await A.from("corporate_vouchers").select("*").eq("voucher_code",s.trim()).maybeSingle();console.log("Corporate query result:",{corporateData:r,corporateError:o});const c=t||r,l=t?"Individual":r?"Corporate":null;if(!c)return console.log("No voucher found for code:",s.trim()),{type:"error",status:"error",message:"Voucher code not found."};console.log("Found voucher:",{type:l,data:c});const v=new Date,m=new Date(c.valid_until)<v;return c.used_at!==null?{type:"voucher",status:"error",message:`${l} voucher has already been used on ${new Date(c.used_at).toLocaleDateString()}.`,data:{...c,voucherType:l}}:m?{type:"voucher",status:"error",message:`${l} voucher has expired.`,data:{...c,voucherType:l}}:{type:"voucher",status:"success",message:`${l} voucher is valid and ready to use!`,data:{...c,voucherType:l}}}catch(t){return console.error("Voucher validation error:",t),{type:"error",status:"error",message:"Error validating voucher."}}},w=i.useCallback(async s=>{if(!s)return;console.log("=== VALIDATION STARTED ==="),console.log("Raw code received:",s),console.log("Code length:",s.length),console.log("Code type:",typeof s),console.log("Code chars:",Array.from(s).map((a,r)=>`[${r}]='${a}' (${a.charCodeAt(0)})`)),d({title:"Scanned Code",description:`Code: "${s}" (length: ${s.length})`,duration:5e3});const t=Date.now();if(s===R.current&&t-V.current<2e3){d({title:"Duplicate Scan",description:"This code was just processed.",variant:"destructive"});return}k(!0),j(null),R.current=s,V.current=t;try{let a;s.startsWith("P<")?a=L(s):a=await Z(s),j(a),y(""),a.status==="success"&&(Q(),P(!0),setTimeout(()=>P(!1),1e3),navigator.vibrate&&navigator.vibrate(200))}catch(a){console.error("Validation error:",a),console.error("Error details:",{message:a.message,stack:a.stack,code:s}),j({type:"error",status:"error",message:`Validation failed: ${a.message||"Please try again."}`}),y("")}finally{k(!1)}},[d]);i.useEffect(()=>{if(!u)return;if(!(window.isSecureContext||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.protocol==="https:")){d({title:"Camera Not Available",description:"Camera access requires HTTPS. Please use manual entry or visit via HTTPS.",variant:"destructive"}),h(!1);return}const t=new te("qr-reader",{fps:10,qrbox:250,rememberLastUsedCamera:!0,showTorchButtonIfSupported:!0},{verbose:!1,formatsToSupport:void 0,useBarCodeDetectorIfSupported:!0,showZoomSliderIfSupported:!0,defaultZoomValueIfSupported:2}),a=o=>{w(o),h(!1)},r=o=>{(o.includes("Permission denied")||o.includes("NotAllowedError"))&&(d({title:"Camera Permission Denied",description:"Please allow camera access and try again.",variant:"destructive"}),h(!1))};return t.render(a,r),()=>{t&&t.getState()===2&&t.clear().catch(o=>console.error("Failed to clear scanner",o))}},[u,w,d]);const O=({result:s})=>{if(!s)return null;const t=s.status==="success",a=t?se:re,r=t?"green":"red";return e.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:e.jsxs(g,{className:`border-${r}-500`,children:[e.jsx(I,{className:`bg-${r}-50`,children:e.jsxs($,{className:`flex items-center gap-2 text-${r}-700`,children:[e.jsx(a,{})," ",t?"Validation Successful":"Validation Failed"]})}),e.jsxs(f,{className:"p-4",children:[e.jsx("p",{className:"font-semibold mb-3",children:s.message}),s.type==="passport"&&s.data&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Passport No:"})," ",s.data.passportNumber]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Name:"})," ",s.data.givenName," ",s.data.surname]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Expiry:"})," ",s.data.dateOfExpiry]})]}),s.type==="voucher"&&s.data&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Type:"})," ",s.data.voucherType," Voucher"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Voucher Code:"})," ",s.data.voucher_code]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Passport:"})," ",s.data.passport_number]}),s.data.company_name&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Company:"})," ",s.data.company_name]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4 text-slate-500"}),e.jsx("strong",{children:"Valid Until:"})," ",new Date(s.data.valid_until).toLocaleDateString()]})]})]})]})})};return e.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-2xl mx-auto p-4 relative",children:[e.jsx(C,{children:B&&e.jsx(x.div,{initial:{opacity:0},animate:{opacity:.3},exit:{opacity:0},className:"fixed inset-0 bg-green-500 pointer-events-none z-50"})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent mb-3",children:"Scan & Validate"}),e.jsx("p",{className:"text-slate-600",children:"Scan passport MRZ codes or voucher QR codes to validate."})]}),e.jsx(g,{className:"mb-8",children:e.jsxs(f,{className:"p-6 space-y-4",children:[e.jsxs(D,{variant:u?"destructive":"default",className:"w-full h-20 text-xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white shadow-lg",onClick:()=>h(s=>!s),disabled:!window.isSecureContext&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&window.location.protocol!=="https:",children:[e.jsx(H,{className:"mr-3 w-8 h-8"}),u?"Close Camera":"Scan with Camera",!window.isSecureContext&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&window.location.protocol!=="https:"&&e.jsx("span",{className:"text-xs text-orange-200 ml-2",children:"(HTTPS required)"})]}),e.jsxs(D,{variant:"outline",className:"w-full h-14 text-base",onClick:()=>document.getElementById("manual-input").focus(),children:[e.jsx(ne,{className:"mr-2"})," Manual Input (Optional)"]}),e.jsx(C,{children:u&&e.jsxs(x.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},children:[e.jsx(g,{className:"mb-4 bg-emerald-50 border-emerald-300",children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(H,{className:"w-6 h-6 text-emerald-600 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-emerald-900 mb-1 text-lg",children:"Allow Camera Access"}),e.jsxs("p",{className:"text-emerald-800 text-sm mb-2",children:["Your browser will ask for camera permission. Please tap ",e.jsx("strong",{children:'"Allow"'})," to scan QR codes."]}),e.jsxs("ul",{className:"text-emerald-700 text-xs space-y-1 list-disc list-inside",children:[e.jsx("li",{children:"Position the QR code within the scanning frame"}),e.jsx("li",{children:"Hold steady until it scans automatically"}),e.jsx("li",{children:"You'll hear a beep when successful"})]})]})]})})}),e.jsx("div",{id:"qr-reader",className:"w-full"})]})}),e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"}),e.jsx(W,{id:"manual-input",placeholder:"Enter code or wait for scanner...",className:"pl-10 h-14 text-lg",value:S,onChange:s=>y(s.target.value),onKeyDown:s=>s.key==="Enter"&&w(S),disabled:T}),T&&e.jsx(J,{className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 animate-spin"})]})]})}),e.jsx(C,{children:e.jsx(O,{result:F})}),e.jsxs(g,{className:"mt-8 bg-blue-50 border-blue-200",children:[e.jsx(I,{children:e.jsxs($,{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(ee,{})," How to Use"]})}),e.jsxs(f,{className:"text-blue-700 space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"USB Scanner:"})," Simply scan a barcode. The system will treat it as keyboard input and process it automatically."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Camera:"})," Click 'Use Camera' and grant permission. Position the QR code or barcode within the frame. ",e.jsx("em",{children:"Requires HTTPS in production."})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Manual:"})," Type or paste the code into the input field and press Enter."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"HTTPS Note:"})," Camera access requires a secure connection (HTTPS) in production environments. Use manual entry or visit via HTTPS for camera functionality."]})]})]})]})};export{he as default};

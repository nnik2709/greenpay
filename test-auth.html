<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Test - PNG Green Fees</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #16B67B;
      margin-top: 0;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #16B67B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #14a36d;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîí Authentication Diagnostic Tool</h1>
    <p>This tool helps debug authentication issues with the PNG Green Fees system.</p>

    <div class="test-section">
      <h3>Step 1: Configure Supabase</h3>
      <label>Supabase URL:</label>
      <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
      
      <label>Supabase Anon Key:</label>
      <input type="text" id="supabaseKey" placeholder="eyJ..." />
      
      <button onclick="initSupabase()">Initialize Supabase</button>
      <div id="initStatus"></div>
    </div>

    <div class="test-section">
      <h3>Step 2: Login</h3>
      <label>Email:</label>
      <input type="email" id="email" value="admin@example.com" />
      
      <label>Password:</label>
      <input type="password" id="password" value="password123" />
      
      <button onclick="testLogin()" id="loginBtn" disabled>Login & Test</button>
      <div id="loginStatus"></div>
    </div>

    <div class="test-section">
      <h3>Step 3: Test Upload Service</h3>
      <button onclick="testUploadAuth()" id="uploadBtn" disabled>Test Upload Authentication</button>
      <div id="uploadStatus"></div>
    </div>

    <div class="test-section">
      <h3>Step 4: Test Database</h3>
      <button onclick="testDatabase()" id="dbBtn" disabled>Test Database Access</button>
      <div id="dbStatus"></div>
    </div>

    <div id="results"></div>
  </div>

  <script>
    let supabase = null;

    function initSupabase() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;
      
      if (!url || !key) {
        showStatus('initStatus', 'Please enter both URL and Key', 'error');
        return;
      }

      try {
        supabase = window.supabase.createClient(url, key);
        showStatus('initStatus', '‚úÖ Supabase client initialized successfully', 'success');
        document.getElementById('loginBtn').disabled = false;
      } catch (error) {
        showStatus('initStatus', '‚ùå Failed to initialize: ' + error.message, 'error');
      }
    }

    async function testLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      showStatus('loginStatus', '‚è≥ Logging in...', 'info');
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        showStatus('loginStatus', '‚úÖ Login successful!<br>User: ' + data.user.email + '<br>ID: ' + data.user.id, 'success');
        
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('dbBtn').disabled = false;
        
      } catch (error) {
        showStatus('loginStatus', '‚ùå Login failed: ' + error.message, 'error');
      }
    }

    async function testUploadAuth() {
      showStatus('uploadStatus', '‚è≥ Testing authentication for upload...', 'info');
      
      try {
        // Test 1: Get session
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          throw new Error('Session error: ' + sessionError.message);
        }
        
        if (!session) {
          throw new Error('No session found');
        }
        
        if (!session.user) {
          throw new Error('No user in session');
        }

        let status = '‚úÖ Authentication tests passed!<br><br>';
        status += '<strong>Session details:</strong><br>';
        status += 'User ID: ' + session.user.id + '<br>';
        status += 'Email: ' + session.user.email + '<br>';
        status += 'Role: ' + session.user.role + '<br>';
        status += 'Session expires: ' + new Date(session.expires_at * 1000).toLocaleString() + '<br>';
        
        showStatus('uploadStatus', status, 'success');
        
      } catch (error) {
        showStatus('uploadStatus', '‚ùå Upload auth test failed: ' + error.message, 'error');
      }
    }

    async function testDatabase() {
      showStatus('dbStatus', '‚è≥ Testing database access...', 'info');
      
      try {
        // Test 1: Query passports
        const { data: passports, error: passportError } = await supabase
          .from('passports')
          .select('id, passport_number, surname')
          .limit(5);

        if (passportError) {
          throw new Error('Passports query failed: ' + passportError.message);
        }

        // Test 2: Query bulk_uploads
        const { data: uploads, error: uploadError } = await supabase
          .from('bulk_uploads')
          .select('*')
          .limit(5);

        if (uploadError) {
          throw new Error('Bulk uploads query failed: ' + uploadError.message);
        }

        let status = '‚úÖ Database access working!<br><br>';
        status += '<strong>Passports table:</strong><br>';
        status += 'Found ' + (passports?.length || 0) + ' passports<br><br>';
        status += '<strong>Bulk uploads table:</strong><br>';
        status += 'Found ' + (uploads?.length || 0) + ' uploads<br><br>';
        
        if (passports && passports.length > 0) {
          status += '<strong>Sample passport:</strong><pre>' + JSON.stringify(passports[0], null, 2) + '</pre>';
        }
        
        showStatus('dbStatus', status, 'success');
        
      } catch (error) {
        showStatus('dbStatus', '‚ùå Database test failed: ' + error.message + '<br><br>This might mean:<br>- Tables not created (run migrations)<br>- RLS policies blocking access<br>- Wrong credentials', 'error');
      }
    }

    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = '<div class="status ' + type + '">' + message + '</div>';
    }

    // Auto-load from localStorage if available
    window.onload = function() {
      const savedUrl = localStorage.getItem('supabaseUrl');
      const savedKey = localStorage.getItem('supabaseKey');
      
      if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
      if (savedKey) document.getElementById('supabaseKey').value = savedKey;
      
      // Try to read from .env (if running via dev server)
      if (typeof import.meta !== 'undefined' && import.meta.env) {
        document.getElementById('supabaseUrl').value = import.meta.env.VITE_SUPABASE_URL || '';
        document.getElementById('supabaseKey').value = import.meta.env.VITE_SUPABASE_ANON_KEY || '';
      }
    };

    // Save to localStorage on change
    document.getElementById('supabaseUrl').addEventListener('change', (e) => {
      localStorage.setItem('supabaseUrl', e.target.value);
    });
    document.getElementById('supabaseKey').addEventListener('change', (e) => {
      localStorage.setItem('supabaseKey', e.target.value);
    });
  </script>
</body>
</html>


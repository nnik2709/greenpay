import{p as ee,s as f,r as l,j as e,_ as d,ai as ae,u as te,B as c,C as se,a as re,b as le,a1 as V,y as ie,d as oe,a3 as ne,D as E,i as S,k as C,l as _,L as v,I as k,o as D,g as ce}from"./index-f386841f.js";import{T as de}from"./textarea-2b2caf3d.js";import{P as me}from"./plus-42d2a69c.js";import{S as M}from"./send-f7a2142e.js";import{T as he}from"./trash-2-10ec2eac.js";import{S as ue}from"./save-bfaf2e9f.js";const xe=ee("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),pe=async()=>{try{const{data:a,error:t}=await f.from("email_templates").select("*").order("name",{ascending:!0});if(t)throw t;return a||[]}catch(a){throw console.error("Error fetching email templates:",a),a}},be=async a=>{try{const{data:t,error:r}=await f.from("email_templates").insert([{name:a.name,subject:a.subject,body:a.body,variables:a.variables||[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(r)throw r;return t}catch(t){throw console.error("Error creating email template:",t),t}},je=async(a,t)=>{try{const{data:r,error:i}=await f.from("email_templates").update({name:t.name,subject:t.subject,body:t.body,variables:t.variables||[],updated_at:new Date().toISOString()}).eq("id",a).select().single();if(i)throw i;return r}catch(r){throw console.error("Error updating email template:",r),r}},ve=async a=>{try{const{error:t}=await f.from("email_templates").delete().eq("id",a);if(t)throw t;return!0}catch(t){throw console.error("Error deleting email template:",t),t}},fe=async(a,t={})=>{try{const{data:r,error:i}=await f.functions.invoke("send-email",{body:{to:t.email||"test@example.com",subject:`TEST: ${a}`,template:a,variables:t.variables||{}}});if(i)throw i;return r}catch(r){throw console.error("Error testing email template:",r),r}},q=a=>{const t=new Set,r=a.match(/\{\{\s*\$([^}]+)\s*\}\}/g);r&&r.forEach(m=>{const o=m.replace(/\{\{\s*\$|\s*\}\}/g,"");t.add(o)});const i=a.match(/\{([^}]+)\}/g);return i&&i.forEach(m=>{const o=m.replace(/\{|\}/g,"");o.includes("$")||t.add(o)}),Array.from(t)},ge=a=>{const t=[];(!a.name||a.name.trim()==="")&&t.push("Template name is required"),(!a.subject||a.subject.trim()==="")&&t.push("Subject is required"),(!a.body||a.body.trim()==="")&&t.push("Body is required");const r=(a.body.match(/<[^\/][^>]*>/g)||[]).length,i=(a.body.match(/<\/[^>]*>/g)||[]).length;return r!==i&&t.push("HTML tags are not properly closed"),t},ye=(a,t={})=>{let r=a.body;return Object.keys(t).forEach(i=>{const m=new RegExp(`\\{\\{[^}]*\\$${i}[^}]*\\}\\}`,"g");r=r.replace(m,t[i]);const o=new RegExp(`\\{${i}\\}`,"g");r=r.replace(o,t[i])}),r},O=a=>({"individual-passport-voucher":{customer_name:"John Doe",voucher_code:"VOUCHER-12345",amount:"PGK 100.00",validity_date:"2025-12-31"},"invoice-email":{"invoice->client_name":"Corporate Client Ltd.","invoice->invoice_number":"INV-2025-001","invoice->invoice_date":"2025-01-15","invoice->due_date":"2025-02-15","invoice->total_vouchers":"50","invoice->voucher_value":"100.00","invoice->amount_after_discount":"5000.00","invoice->payment_mode":"bank transfer"},welcome:{"user->name":"Jane Smith","user->email":"jane.smith@example.com",password:"temp123",loginUrl:"https://app.example.com/login"},"quotation-email":{"quotation->client_name":"ABC Corporation","quotation->quotation_number":"QUO-2025-001","quotation->subject":"Government Exit Pass Vouchers","quotation->total_amount":"10000.00","quotation->total_vouchers":"100","quotation->voucher_value":"100.00","quotation->validity_date":"2025-12-31"},ticket_created:{"ticket->subject":"Unable to access system","ticket->category":"Technical Support","ticket->priority":"High","ticket->description":"I am unable to log into the system. Getting an error message.","ticket->user->name":"John User","ticket->created_at":"2025-01-15 10:30:00"}})[a]||{},$=l.forwardRef(({className:a,...t},r)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:r,className:d("w-full caption-bottom text-sm",a),...t})}));$.displayName="Table";const I=l.forwardRef(({className:a,...t},r)=>e.jsx("thead",{ref:r,className:d("[&_tr]:border-b",a),...t}));I.displayName="TableHeader";const B=l.forwardRef(({className:a,...t},r)=>e.jsx("tbody",{ref:r,className:d("[&_tr:last-child]:border-0",a),...t}));B.displayName="TableBody";const we=l.forwardRef(({className:a,...t},r)=>e.jsx("tfoot",{ref:r,className:d("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...t}));we.displayName="TableFooter";const H=l.forwardRef(({className:a,...t},r)=>e.jsx("tr",{ref:r,className:d("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...t}));H.displayName="TableRow";const u=l.forwardRef(({className:a,...t},r)=>e.jsx("th",{ref:r,className:d("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...t}));u.displayName="TableHead";const x=l.forwardRef(({className:a,...t},r)=>e.jsx("td",{ref:r,className:d("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...t}));x.displayName="TableCell";const Ne=l.forwardRef(({className:a,...t},r)=>e.jsx("caption",{ref:r,className:d("mt-4 text-sm text-muted-foreground",a),...t}));Ne.displayName="TableCaption";const Te=ae("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function R({className:a,variant:t,...r}){return e.jsx("div",{className:d(Te({variant:t}),a),...r})}const qe=()=>{const{toast:a}=te(),[t,r]=l.useState([]),[i,m]=l.useState(!0),[o,g]=l.useState(null),[A,p]=l.useState(!1),[U,N]=l.useState(!1),[z,y]=l.useState(!1),[L,J]=l.useState({}),[b,F]=l.useState(""),[n,j]=l.useState({name:"",subject:"",body:"",variables:[]});l.useEffect(()=>{T()},[]);const T=async()=>{try{m(!0);const s=await pe();r(s)}catch{a({title:"Error",description:"Failed to load email templates",variant:"destructive"})}finally{m(!1)}},G=s=>{g(s),j({name:s.name,subject:s.subject,body:s.body,variables:s.variables||[]}),p(!0)},P=()=>{g(null),j({name:"",subject:"",body:"",variables:[]}),p(!0)},K=async()=>{try{const s=ge(n);if(s.length>0){a({title:"Validation Error",description:s.join(", "),variant:"destructive"});return}const h=q(n.body),w={...n,variables:h};o?(await je(o.id,w),a({title:"Success",description:"Email template updated successfully"})):(await be(w),a({title:"Success",description:"Email template created successfully"})),p(!1),T()}catch(s){a({title:"Error",description:s.message||"Failed to save template",variant:"destructive"})}},Q=async s=>{if(confirm(`Are you sure you want to delete the template "${s.name}"?`))try{await ve(s.id),a({title:"Success",description:"Email template deleted successfully"}),T()}catch(h){a({title:"Error",description:h.message||"Failed to delete template",variant:"destructive"})}},W=s=>{g(s),J(O(s.name)),N(!0)},Y=s=>{g(s),F(""),y(!0)},Z=async()=>{if(!(!b||!o))try{await fe(o.name,{email:b,variables:O(o.name)}),a({title:"Success",description:`Test email sent to ${b}`}),y(!1)}catch(s){a({title:"Error",description:s.message||"Failed to send test email",variant:"destructive"})}},X=()=>o?ye(o,L):"";return i?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"text-lg",children:"Loading email templates..."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent",children:"Email Templates"}),e.jsx("p",{className:"text-slate-600 mt-2",children:"Manage email templates for automated communications"})]}),e.jsxs(c,{onClick:P,className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-4 h-4"}),"New Template"]})]}),e.jsxs(se,{children:[e.jsxs(re,{children:[e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5"}),"Templates (",t.length,")"]}),e.jsx(ie,{children:"Click edit to modify templates, preview to see how they look, or test to send a sample email"})]}),e.jsx(oe,{children:t.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(V,{className:"w-12 h-12 mx-auto mb-4 text-slate-300"}),e.jsx("p",{children:"No email templates found"}),e.jsx(c,{onClick:P,className:"mt-4",children:"Create Your First Template"})]}):e.jsxs($,{children:[e.jsx(I,{children:e.jsxs(H,{children:[e.jsx(u,{children:"Name"}),e.jsx(u,{children:"Subject"}),e.jsx(u,{children:"Variables"}),e.jsx(u,{children:"Updated"}),e.jsx(u,{className:"text-right",children:"Actions"})]})}),e.jsx(B,{children:t.map(s=>e.jsxs(H,{children:[e.jsx(x,{className:"font-medium",children:s.name}),e.jsx(x,{className:"max-w-xs truncate",children:s.subject}),e.jsx(x,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[(s.variables||[]).slice(0,3).map((h,w)=>e.jsx(R,{variant:"secondary",className:"text-xs",children:h},w)),(s.variables||[]).length>3&&e.jsxs(R,{variant:"outline",className:"text-xs",children:["+",(s.variables||[]).length-3," more"]})]})}),e.jsx(x,{className:"text-sm text-slate-500",children:new Date(s.updated_at).toLocaleDateString()}),e.jsx(x,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>W(s),children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>Y(s),children:e.jsx(M,{className:"w-4 h-4"})}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>G(s),children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>Q(s),className:"text-red-600 hover:text-red-700",children:e.jsx(he,{className:"w-4 h-4"})})]})})]},s.id))})]})})]}),e.jsx(E,{open:A,onOpenChange:p,children:e.jsxs(S,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(C,{children:e.jsx(_,{children:o?"Edit Template":"Create New Template"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"name",children:"Template Name"}),e.jsx(k,{id:"name",value:n.name,onChange:s=>j({...n,name:s.target.value}),placeholder:"e.g., welcome-email"})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"subject",children:"Subject Line"}),e.jsx(k,{id:"subject",value:n.subject,onChange:s=>j({...n,subject:s.target.value}),placeholder:"e.g., Welcome to {app.name}"})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"body",children:"Email Body (HTML)"}),e.jsx(de,{id:"body",value:n.body,onChange:s=>j({...n,body:s.target.value}),placeholder:"Enter HTML content...",className:"min-h-[400px] font-mono text-sm"}),e.jsxs("p",{className:"text-sm text-slate-500 mt-1",children:["Use ",{$variable}," for Laravel syntax or ","{variable}"," for simple placeholders"]})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Detected Variables"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[q(n.body).map((s,h)=>e.jsx(R,{variant:"secondary",children:s},h)),q(n.body).length===0&&e.jsx("span",{className:"text-sm text-slate-500",children:"No variables detected"})]})]})]}),e.jsxs(D,{children:[e.jsx(c,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsxs(c,{onClick:K,className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),"Save Template"]})]})]})}),e.jsx(E,{open:U,onOpenChange:N,children:e.jsxs(S,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(C,{children:e.jsx(_,{children:"Email Preview"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Sample Data"}),e.jsx("pre",{className:"text-sm bg-white p-3 rounded border overflow-auto",children:JSON.stringify(L,null,2)})]}),e.jsxs("div",{className:"border rounded-lg",children:[e.jsx("div",{className:"bg-slate-100 p-3 border-b",children:e.jsx("h3",{className:"font-semibold",children:"Rendered Email"})}),e.jsx("div",{className:"p-4 max-h-96 overflow-auto",dangerouslySetInnerHTML:{__html:X()}})]})]}),e.jsx(D,{children:e.jsx(c,{variant:"outline",onClick:()=>N(!1),children:"Close"})})]})}),e.jsx(E,{open:z,onOpenChange:y,children:e.jsxs(S,{children:[e.jsx(C,{children:e.jsx(_,{children:"Send Test Email"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"testEmail",children:"Email Address"}),e.jsx(k,{id:"testEmail",type:"email",value:b,onChange:s=>F(s.target.value),placeholder:"test@example.com"})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-yellow-800",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Test Email"})]}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:"A test email will be sent with sample data to verify the template works correctly."})]})]}),e.jsxs(D,{children:[e.jsx(c,{variant:"outline",onClick:()=>y(!1),children:"Cancel"}),e.jsxs(c,{onClick:Z,disabled:!b,className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),"Send Test Email"]})]})]})})]})};export{qe as default};

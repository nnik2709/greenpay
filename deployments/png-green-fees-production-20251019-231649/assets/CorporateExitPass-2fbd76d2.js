import{s as W,u as X,v as Y,h as Z,r as t,j as e,m as v,B as y,A as ee,C as f,a as N,b,ad as se,d as w,L as r,I as i,e as te,a9 as $,P as ae}from"./index-f386841f.js";import{R as ne,a as re}from"./radio-group-188719c7.js";import{g as z}from"./paymentModesStorage-3d8fa5db.js";import{V as ie}from"./VoucherPrint-580d5f3f.js";import{H as oe}from"./history-bbb4473d.js";import{H as le}from"./hash-110faeb3.js";const ce=async a=>{var c;const{data:m}=await W.auth.getSession(),h=(c=m==null?void 0:m.session)==null?void 0:c.access_token;if(!h)throw new Error("Not authenticated");const p="https://gzaezpexrtwwpntclonu.supabase.co/functions/v1/bulk-corporate",C={company_name:a.companyName,count:a.count,amount:a.amount,payment_method:a.paymentMethod,valid_from:a.validFrom||new Date().toISOString(),valid_until:a.validUntil},l=await fetch(p,{method:"POST",headers:{Authorization:`Bearer ${h}`,"Content-Type":"application/json"},body:JSON.stringify(C)});if(!l.ok){const j=await l.text();throw new Error(j||"Failed to create corporate vouchers")}return(await l.json()).vouchers||[]},je=()=>{const{toast:a}=X();Y();const m=Z(),[h,p]=t.useState(0),[C,l]=t.useState([]),[u,c]=t.useState(""),[j,A]=t.useState(!1),[g,E]=t.useState(""),[x,M]=t.useState(1),[G,I]=t.useState(0),[S,T]=t.useState(50),[P,D]=t.useState(""),[O,B]=t.useState([]),[k,H]=t.useState(null),[K,L]=t.useState(!1),R=50,V=x*R,d=V-V*(G/100),U=S-d;t.useEffect(()=>{(async()=>{const o=(await z()).filter(_=>_.active);l(o),o.length>0&&c(o[0].name)})();const n=new Date;n.setDate(n.getDate()+30),D(n.toISOString().split("T")[0])},[]),t.useEffect(()=>{const s=()=>{document.hidden||(async()=>{const o=(await z()).filter(_=>_.active);l(o),o.length>0&&!u&&c(o[0].name)})()};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[u]),t.useEffect(()=>{T(d)},[d]);const q=async s=>{if(s.preventDefault(),!g.trim()){a({variant:"destructive",title:"Company Name Required",description:"Please enter a company name."});return}if(x<1){a({variant:"destructive",title:"Invalid Quantity",description:"Please enter at least 1 voucher."});return}if(S<d){a({variant:"destructive",title:"Insufficient Amount",description:"Collected amount is less than the total."});return}A(!0);try{const n={companyName:g.trim(),count:x,amount:R,paymentMethod:u,validFrom:new Date().toISOString(),validUntil:new Date(P).toISOString()},F=await ce(n);B(F),p(1),a({title:"Success!",description:`${x} corporate vouchers generated successfully.`})}catch(n){console.error("Error generating vouchers:",n),a({variant:"destructive",title:"Error",description:`Failed to generate vouchers: ${n.message||"Please try again."}`})}finally{A(!1)}},J=s=>{H(s),L(!0)},Q=()=>{p(0),E(""),M(1),I(0),B([])};return e.jsxs(v.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-6xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent",children:"Corporate Exit Pass"}),e.jsxs(y,{onClick:()=>m("/corporate-batch-history"),variant:"outline",className:"text-emerald-600 border-emerald-300 hover:bg-emerald-50",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Batch History"]})]}),e.jsxs(ee,{mode:"wait",children:[h===0&&e.jsx(v.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:e.jsxs(f,{children:[e.jsx(N,{children:e.jsxs(b,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-6 h-6"}),"Bulk Voucher Generation"]})}),e.jsx(w,{children:e.jsxs("form",{onSubmit:q,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"company_name",children:"Company Name *"}),e.jsx(i,{id:"company_name",placeholder:"Enter company name",value:g,onChange:s=>E(s.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"total_vouchers",children:"Number of Vouchers *"}),e.jsx(i,{id:"total_vouchers",type:"number",min:"1",value:x,onChange:s=>M(parseInt(s.target.value,10)||1)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"total_amount",children:"Total Amount (PGK)"}),e.jsx(i,{id:"total_amount",value:V.toFixed(2),readOnly:!0,className:"bg-slate-100 font-bold"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"discount",children:"Discount (%)"}),e.jsx(i,{id:"discount",type:"number",min:"0",max:"100",value:G,onChange:s=>I(parseFloat(s.target.value)||0)})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"amount_after_discount",children:"Amount After Discount"}),e.jsx(i,{id:"amount_after_discount",value:d.toFixed(2),readOnly:!0,className:"bg-slate-100 font-bold"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"collected_amount",children:"Collected Amount (PGK)"}),e.jsx(i,{id:"collected_amount",type:"number",value:S,onChange:s=>T(parseFloat(s.target.value)||0)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"returned_amount",children:"Change/Returned Amount"}),e.jsx(i,{id:"returned_amount",value:U>0?U.toFixed(2):"0.00",readOnly:!0,className:"bg-slate-100"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"valid_until",children:"Valid Until *"}),e.jsx(i,{id:"valid_until",type:"date",value:P,onChange:s=>D(s.target.value),required:!0})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(r,{className:"text-base font-semibold",children:"Payment Method *"}),e.jsx(ne,{value:u,onValueChange:c,className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:C.map(s=>e.jsxs("div",{className:"flex items-center space-x-2 border rounded-lg p-3 hover:bg-slate-50",children:[e.jsx(re,{value:s.name,id:`corp-${s.name}`}),e.jsx(r,{htmlFor:`corp-${s.name}`,className:"font-normal cursor-pointer flex-1",children:s.name})]},s.id))})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(y,{type:"submit",size:"lg",disabled:j,className:"bg-gradient-to-r from-emerald-500 to-teal-600",children:j?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-5 h-5 mr-2 animate-spin"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-5 h-5 mr-2"}),"Generate Vouchers"]})})})]})})]})},"form"),h===1&&e.jsxs(v.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},className:"space-y-6",children:[e.jsxs(f,{className:"border-green-200",children:[e.jsx(N,{className:"bg-green-50",children:e.jsxs(b,{className:"flex items-center gap-2 text-green-700",children:[e.jsx($,{className:"w-6 h-6"}),"Vouchers Generated Successfully!"]})}),e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Company:"}),e.jsx("p",{className:"font-semibold",children:g})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Total Vouchers:"}),e.jsx("p",{className:"font-semibold",children:O.length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Total Amount:"}),e.jsxs("p",{className:"font-semibold",children:["PGK ",d.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Valid Until:"}),e.jsx("p",{className:"font-semibold",children:new Date(P).toLocaleDateString()})]})]})})]}),e.jsxs(f,{children:[e.jsx(N,{children:e.jsxs(b,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"All Generated Vouchers"}),e.jsx(y,{variant:"outline",onClick:Q,children:"Create Another Batch"})]})}),e.jsx(w,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:O.map((s,n)=>e.jsx(v.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:n*.05},children:e.jsxs(f,{className:"border-emerald-200 hover:shadow-lg transition-shadow",children:[e.jsx(N,{className:"pb-3 bg-emerald-50",children:e.jsxs(b,{className:"text-base flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"}),"Voucher #",n+1]})}),e.jsxs(w,{className:"space-y-3 text-sm p-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Code:"}),e.jsx("p",{className:"font-mono font-bold text-emerald-600 break-all",children:s.voucher_code})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Amount:"}),e.jsxs("p",{className:"font-semibold",children:["PGK ",s.amount]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Status:"}),e.jsx("p",{className:"font-semibold text-green-600",children:"Valid"})]}),e.jsxs(y,{size:"sm",onClick:()=>J(s),className:"w-full bg-emerald-600 hover:bg-emerald-700",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Print Voucher"]})]})]})},s.id))})})]})]},"list")]}),k&&e.jsx(ie,{voucher:k,isOpen:K,onClose:()=>{L(!1),H(null)},voucherType:"Corporate"})]})};export{je as default};

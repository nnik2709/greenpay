import{u as M,r,s as v,j as e,C as o,d,ag as B,U as S,I as D,a as E,b as F,m as Z,B as f,a3 as Q,w as q,a1 as Y}from"./index-f386841f.js";import{S as J,a as O,b as W,c as X,d as N}from"./select-14269127.js";import{E as ee}from"./ExportButton-bbdea4ab.js";import{D as A}from"./dollar-sign-54a6a05d.js";import{C as I}from"./calendar-a622c72a.js";import{S as se}from"./search-0da320f8.js";import{F as te}from"./filter-df158437.js";import"./xlsx-f5126985.js";import"./file-spreadsheet-279cbcb4.js";const xe=()=>{const{toast:x}=M(),[y,_]=r.useState([]),[n,k]=r.useState([]),[V,b]=r.useState(!0),[h,U]=r.useState(""),[m,L]=r.useState(""),[u,P]=r.useState(""),[i,R]=r.useState(null),[T,w]=r.useState(!1);r.useEffect(()=>{z()},[]),r.useEffect(()=>{H()},[y,h,m,u]);const z=async()=>{try{b(!0);const{data:s,error:t}=await v.from("corporate_vouchers").select(`
          *,
          profiles!inner(
            id,
            full_name,
            email
          )
        `).order("created_at",{ascending:!1});if(t)throw t;const a=new Map;(s||[]).forEach(l=>{var C;const j=l.batch_id||"individual";a.has(j)||a.set(j,{batchId:j,companyName:l.company_name||"Unknown Company",contactEmail:l.contact_email||"No email",createdBy:((C=l.profiles)==null?void 0:C.full_name)||"Unknown",createdAt:l.created_at,vouchers:[],totalAmount:0,usedCount:0,status:"active"});const g=a.get(j);g.vouchers.push(l),g.totalAmount+=parseFloat(l.amount||0),l.used_at&&g.usedCount++});const c=Array.from(a.values()).map(l=>({...l,voucherCount:l.vouchers.length,usageRate:l.vouchers.length>0?(l.usedCount/l.vouchers.length*100).toFixed(1):0}));_(c)}catch(s){console.error("Error fetching batches:",s),x({title:"Error",description:"Failed to load corporate batch history",variant:"destructive"})}finally{b(!1)}},H=()=>{let s=[...y];if(h){const t=h.toLowerCase();s=s.filter(a=>a.companyName.toLowerCase().includes(t)||a.contactEmail.toLowerCase().includes(t)||a.createdBy.toLowerCase().includes(t)||a.batchId.toLowerCase().includes(t))}if(m&&(m==="used"?s=s.filter(t=>t.usedCount>0):m==="unused"?s=s.filter(t=>t.usedCount===0):m==="partial"&&(s=s.filter(t=>t.usedCount>0&&t.usedCount<t.voucherCount))),u){const t=new Date(u),a=new Date(t);a.setDate(a.getDate()+1),s=s.filter(c=>{const l=new Date(c.createdAt);return l>=t&&l<a})}k(s)},$=async s=>{try{const{data:t,error:a}=await v.functions.invoke("generate-corporate-zip",{body:{batchId:s}});if(a)throw a;const c=document.createElement("a");c.href=t.downloadUrl,c.download=`corporate-batch-${s}.zip`,document.body.appendChild(c),c.click(),document.body.removeChild(c),x({title:"Download Started",description:"Corporate batch ZIP file is being downloaded"})}catch(t){console.error("Error downloading batch:",t),x({title:"Download Failed",description:t.message||"Failed to download batch ZIP",variant:"destructive"})}},G=async(s,t)=>{try{const{error:a}=await v.functions.invoke("send-voucher-batch",{body:{batchId:s,email:t,message:"Your corporate voucher batch is ready for download."}});if(a)throw a;x({title:"Email Sent",description:`Batch sent to ${t}`})}catch(a){console.error("Error emailing batch:",a),x({title:"Email Failed",description:a.message||"Failed to send batch email",variant:"destructive"})}},K=[{name:"Batch ID",selector:s=>s.batchId},{name:"Company",selector:s=>s.companyName},{name:"Contact Email",selector:s=>s.contactEmail},{name:"Created By",selector:s=>s.createdBy},{name:"Created Date",selector:s=>new Date(s.createdAt).toLocaleString()},{name:"Voucher Count",selector:s=>s.voucherCount},{name:"Total Amount",selector:s=>`PGK ${s.totalAmount.toFixed(2)}`},{name:"Used Count",selector:s=>s.usedCount},{name:"Usage Rate",selector:s=>`${s.usageRate}%`}],p={total:n.length,totalVouchers:n.reduce((s,t)=>s+t.voucherCount,0),totalAmount:n.reduce((s,t)=>s+t.totalAmount,0),usedVouchers:n.reduce((s,t)=>s+t.usedCount,0)};return V?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent",children:"Corporate Batch History"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"View and manage corporate voucher batches"})]}),e.jsx(ee,{data:n,columns:K,filename:"Corporate_Batch_History_Report",title:"Corporate Batch History Report"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(o,{children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5 text-emerald-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total Batches"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:p.total})]})]})})}),e.jsx(o,{children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total Vouchers"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:p.totalVouchers})]})]})})}),e.jsx(o,{children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total Amount"}),e.jsxs("p",{className:"text-2xl font-bold text-slate-800",children:["PGK ",p.totalAmount.toFixed(2)]})]})]})})}),e.jsx(o,{children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Used Vouchers"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:p.usedVouchers})]})]})})})]}),e.jsx(o,{children:e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(D,{placeholder:"Search by company, email, or batch ID...",className:"pl-10",value:h,onChange:s=>U(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Status"}),e.jsxs(J,{value:m,onValueChange:L,children:[e.jsx(O,{children:e.jsx(W,{placeholder:"All statuses"})}),e.jsxs(X,{children:[e.jsx(N,{value:"",children:"All statuses"}),e.jsx(N,{value:"unused",children:"Unused"}),e.jsx(N,{value:"partial",children:"Partially used"}),e.jsx(N,{value:"used",children:"Fully used"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Date"}),e.jsx(D,{type:"date",value:u,onChange:s=>P(s.target.value)})]})]})})}),e.jsxs(o,{children:[e.jsx(E,{children:e.jsxs(F,{children:["Corporate Batches (",n.length," batches)"]})}),e.jsx(d,{children:n.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"No corporate batches found matching your criteria."}):e.jsx("div",{className:"space-y-4",children:n.map((s,t)=>e.jsx(Z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:t*.05},className:"border border-slate-200 rounded-lg p-4 hover:bg-slate-50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center",children:e.jsx(B,{className:"w-4 h-4 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-800",children:s.companyName}),e.jsxs("p",{className:"text-sm text-slate-500",children:["Batch ID: ",s.batchId," â€¢ Created by ",s.createdBy]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{children:new Date(s.createdAt).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{children:[s.voucherCount," vouchers"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{children:["PGK ",s.totalAmount.toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{children:[s.usageRate,"% used"]})]})]})]}),e.jsxs("div",{className:"flex gap-2 ml-4",children:[e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>{R(s),w(!0)},children:[e.jsx(Q,{className:"w-4 h-4 mr-1"}),"Details"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>$(s.batchId),children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),"Download"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>G(s.batchId,s.contactEmail),children:[e.jsx(Y,{className:"w-4 h-4 mr-1"}),"Email"]})]})]})},s.batchId))})})]}),T&&i&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:e.jsxs(o,{className:"w-full max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(E,{children:e.jsxs(F,{className:"flex items-center justify-between",children:[e.jsxs("span",{children:["Batch Details - ",i.companyName]}),e.jsx(f,{variant:"outline",onClick:()=>w(!1),children:"Close"})]})}),e.jsxs(d,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Batch ID"}),e.jsx("p",{className:"font-semibold",children:i.batchId})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Company"}),e.jsx("p",{className:"font-semibold",children:i.companyName})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Contact Email"}),e.jsx("p",{className:"font-semibold",children:i.contactEmail})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Created By"}),e.jsx("p",{className:"font-semibold",children:i.createdBy})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Vouchers in this batch:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Voucher Code"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Passport"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Status"})]})}),e.jsx("tbody",{children:i.vouchers.map((s,t)=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-3 py-2 font-mono",children:s.voucher_code}),e.jsx("td",{className:"px-3 py-2",children:s.passport_number}),e.jsxs("td",{className:"px-3 py-2",children:["PGK ",s.amount]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.used_at?"bg-green-100 text-green-800":"bg-slate-100 text-slate-800"}`,children:s.used_at?"Used":"Unused"})})]},t))})]})})]})]})]})})]})};export{xe as default};

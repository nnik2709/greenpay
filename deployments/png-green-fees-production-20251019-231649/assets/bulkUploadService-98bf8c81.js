import{s as y}from"./index-f386841f.js";async function E(t){return new Promise((u,g)=>{const m=new FileReader;m.onload=h=>{try{const n=h.target.result.split(`
`).filter(s=>s.trim());if(n.length<2){g(new Error("File is empty or has no data"));return}const p=n[0].split(",").map(s=>s.trim()),l=[];for(let s=1;s<n.length;s++){const c=n[s].split(",").map(w=>w.trim()),a={};p.forEach((w,f)=>{a[w]=c[f]||""}),l.push(a)}u(l)}catch{g(new Error("Failed to parse CSV file"))}},m.onerror=()=>g(new Error("Failed to read file")),m.readAsText(t)})}async function _(t){if(console.log("Starting bulk upload for file:",t.name),!t)throw new Error("No file provided");const u=t.name.split(".").pop().toLowerCase();if(!["xls","xlsx","csv"].includes(u))throw new Error("Only Excel (.xlsx, .xls) and CSV files are supported");const m=10*1024*1024;if(t.size>m)throw new Error("File size must be less than 10MB");try{if(!y)throw console.error("Supabase client not initialized"),new Error("Database connection not available");console.log("Checking authentication...");const{data:{session:h},error:b}=await y.auth.getSession();if(b)throw console.error("Session error:",b),new Error("Authentication failed. Please refresh and try again.");if(!h||!h.user)throw console.error("No session or user found"),new Error("Not authenticated. Please log in.");const n=h.user;if(console.log("User authenticated:",n.email,"ID:",n.id),u!=="csv")throw new Error("Excel files require the Edge Function to be deployed. Please use CSV files or deploy the Edge Function.");console.log("Processing CSV locally...",{fileName:t.name,fileSize:t.size,userId:n.id});const p=await E(t);console.log("CSV parsed successfully, rows:",p.length);const l=[],s=[];for(let r=0;r<p.length;r++){const e=p[r],o=[];if((!e.passportNo||e.passportNo.length<5)&&o.push(`Row ${r+1}: Passport number is required (min 5 characters)`),e.surname||o.push(`Row ${r+1}: Surname is required`),e.givenName||o.push(`Row ${r+1}: Given name is required`),e.nationality||o.push(`Row ${r+1}: Nationality is required`),e.dob||o.push(`Row ${r+1}: Date of birth is required`),e.sex||o.push(`Row ${r+1}: Sex is required`),e.dateOfExpiry||o.push(`Row ${r+1}: Date of expiry is required`),o.length>0)l.push(...o);else{let d=e.sex;d==="M"&&(d="Male"),d==="F"&&(d="Female"),s.push({passport_number:e.passportNo.toUpperCase(),surname:e.surname,given_name:e.givenName,nationality:e.nationality,date_of_birth:e.dob,sex:d,date_of_expiry:e.dateOfExpiry,created_by:n.id})}}const c=[],a=[];if(s.length>0){console.log("Inserting valid rows:",s.length);const r=100;for(let e=0;e<s.length;e+=r){const o=s.slice(e,e+r);console.log(`Inserting batch ${Math.floor(e/r)+1}, records:`,o.length),console.log("Sample record:",o[0]);const{data:d,error:i}=await y.from("passports").insert(o).select("id, passport_number, surname, given_name");i?(console.error("Insert error details:",{message:i.message,details:i.details,hint:i.hint,code:i.code}),i.message&&/duplicate/i.test(i.message)?a.push("Some passport numbers already exist in the database"):i.message&&/permission/i.test(i.message)?a.push("Permission denied - check RLS policies or authentication"):a.push(`Database error: ${i.message}`)):d&&(console.log("Batch inserted successfully:",d.length),c.push(...d))}}else console.log("No valid rows to insert");console.log("Creating upload log entry...");const w=`BULK_${Date.now()}_${n.id.substring(0,8)}`,{error:f}=await y.from("bulk_uploads").insert({batch_id:w,file_name:t.name,total_records:p.length,successful_records:c.length,failed_records:l.length+a.length,created_by:n.id,status:c.length>0?"completed":"failed",error_log:l.length+a.length>0?[...l,...a]:null,completed_at:new Date().toISOString()});return f?(console.error("Failed to create upload log:",f),console.error("Log error details:",{message:f.message,details:f.details,hint:f.hint})):console.log("Upload log created successfully"),{success:c.length>0,passports:c,errors:[...l,...a],totalProcessed:p.length,successCount:c.length,errorCount:l.length+a.length,message:`Successfully processed ${c.length} out of ${p.length} passports`}}catch(h){throw console.error("Bulk upload error:",h),h}}async function S(t=10){try{const{data:u,error:g}=await y.from("bulk_uploads").select(`
        *,
        uploader:created_by(full_name, email)
      `).order("created_at",{ascending:!1}).limit(t);return g?(console.error("Error fetching upload history:",g),[]):u||[]}catch(u){return console.error("Error fetching upload history:",u),[]}}export{S as g,_ as u};

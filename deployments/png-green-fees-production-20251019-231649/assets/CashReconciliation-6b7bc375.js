import{p as O,s as K,u as $,v as z,r as x,j as e,m as B,B as C,F as Y,C as g,a as w,b as S,d as y,L as F,I as k,g as J,f as Q,D as U,i as W,k as X,l as Z,n as ee,o as te}from"./index-f386841f.js";import{C as I}from"./calendar-a622c72a.js";import{D as se}from"./dollar-sign-54a6a05d.js";const ae=O("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]),ne=O("Coins",[["circle",{cx:"8",cy:"8",r:"6",key:"3yglwk"}],["path",{d:"M18.09 10.37A6 6 0 1 1 10.34 18",key:"t5s6rm"}],["path",{d:"M7 6h1v4",key:"1obek4"}],["path",{d:"m16.71 13.88.7.71-2.82 2.82",key:"1rbuyh"}]]),le=async(s={})=>{try{let a=K.from("cash_reconciliations").select("*").order("created_at",{ascending:!1});s.date_from&&(a=a.gte("reconciliation_date",s.date_from)),s.date_to&&(a=a.lte("reconciliation_date",s.date_to)),s.agent_id&&(a=a.eq("agent_id",s.agent_id)),s.status&&(a=a.eq("status",s.status));const{data:l,error:m}=await a;if(m)throw m;return l||[]}catch(a){throw console.error("Error fetching reconciliations:",a),a}},ie=async(s,a)=>{try{const l=new Date(s);l.setHours(0,0,0,0);const m=new Date(s);m.setHours(23,59,59,999);const{data:n,error:b}=await K.from("transactions").select("*").eq("created_by",a).gte("created_at",l.toISOString()).lte("created_at",m.toISOString());if(b)throw b;const p={total:0,cash:0,card:0,bankTransfer:0,eftpos:0,transactions:n||[],count:(n==null?void 0:n.length)||0};return(n||[]).forEach(f=>{var i;const r=parseFloat(f.amount)||0;p.total+=r;const c=(i=f.payment_method)==null?void 0:i.toLowerCase();c==="cash"?p.cash+=r:c!=null&&c.includes("card")||c==="credit card"||c==="debit card"?p.card+=r:c==="bank transfer"?p.bankTransfer+=r:c==="eftpos"&&(p.eftpos+=r)}),p}catch(l){throw console.error("Error fetching transactions for reconciliation:",l),l}},re=async s=>{try{const{data:a,error:l}=await K.from("cash_reconciliations").insert([{agent_id:s.agentId,reconciliation_date:s.date,opening_float:s.openingFloat||0,expected_cash:s.expectedCash||0,actual_cash:s.actualCash||0,variance:s.variance||0,cash_denominations:s.denominations||{},card_transactions:s.cardTotal||0,bank_transfers:s.bankTransferTotal||0,eftpos_transactions:s.eftposTotal||0,total_collected:s.totalCollected||0,notes:s.notes||"",status:"pending",created_at:new Date().toISOString()}]).select().single();if(l)throw l;return a}catch(a){throw console.error("Error creating reconciliation:",a),a}},E=(s,a)=>a-s,ce=s=>{const a={100:s.hundred||0,50:s.fifty||0,20:s.twenty||0,10:s.ten||0,5:s.five||0,2:s.two||0,1:s.one||0,.5:s.fiftyCents||0,.2:s.twentyCents||0,.1:s.tenCents||0,.05:s.fiveCents||0};return Object.entries(a).reduce((l,[m,n])=>l+parseFloat(m)*parseInt(n||0),0)},he=()=>{const{toast:s}=$(),{user:a}=z(),[l,m]=x.useState(new Date().toISOString().split("T")[0]),[n,b]=x.useState(null),[p,f]=x.useState(!1),[r,c]=x.useState(0),[i,D]=x.useState({hundred:0,fifty:0,twenty:0,ten:0,five:0,two:0,one:0,fiftyCents:0,twentyCents:0,tenCents:0,fiveCents:0}),[P,G]=x.useState(""),[v,M]=x.useState(0),[R,L]=x.useState([]),[H,_]=x.useState(!1);x.useEffect(()=>{l&&a&&T()},[l,a]),x.useEffect(()=>{const t=ce(i);M(t)},[i]);const T=async()=>{f(!0);try{const t=await ie(l,a.id);b(t)}catch{s({variant:"destructive",title:"Error",description:"Failed to load transaction summary."})}finally{f(!1)}},A=async()=>{try{const t=await le({agent_id:a.id});L(t)}catch{s({variant:"destructive",title:"Error",description:"Failed to load reconciliation history."})}},o=(t,h)=>{D(u=>({...u,[t]:parseInt(h)||0}))},V=async()=>{if(!n){s({variant:"destructive",title:"No Data",description:"Please load transaction summary first."});return}const t=n.cash+r,h=E(t,v);try{const u={agentId:a.id,date:l,openingFloat:r,expectedCash:t,actualCash:v,variance:h,denominations:i,cardTotal:n.card,bankTransferTotal:n.bankTransfer,eftposTotal:n.eftpos,totalCollected:n.total,notes:P};await re(u),s({title:"Reconciliation Submitted!",description:`Variance: PGK ${h.toFixed(2)}`}),D({hundred:0,fifty:0,twenty:0,ten:0,five:0,two:0,one:0,fiftyCents:0,twentyCents:0,tenCents:0,fiveCents:0}),G(""),c(0),T()}catch{s({variant:"destructive",title:"Error",description:"Failed to submit reconciliation."})}},j=n?E(n.cash+r,v):0,d=({label:t,value:h,onChange:u,denomination:N})=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(F,{className:"w-20 text-right",children:t}),e.jsx(k,{type:"number",min:"0",value:h,onChange:q=>u(q.target.value),className:"w-24"}),e.jsxs("span",{className:"text-sm text-slate-500",children:["= PGK ",(N*(h||0)).toFixed(2)]})]});return e.jsxs(B.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent",children:"Cash Reconciliation"}),e.jsxs(C,{variant:"outline",onClick:()=>{A(),_(!0)},children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"View History"]})]}),e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-emerald-600"}),"Select Reconciliation Date"]})}),e.jsx(y,{children:e.jsxs("div",{className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(F,{children:"Date"}),e.jsx(k,{type:"date",value:l,onChange:t=>m(t.target.value),max:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(F,{children:"Opening Float (PGK)"}),e.jsx(k,{type:"number",value:r,onChange:t=>c(parseFloat(t.target.value)||0),placeholder:"0.00"})]}),e.jsx(C,{onClick:T,disabled:p,children:p?"Loading...":"Load Transactions"})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-emerald-600"}),"Transaction Summary for ",new Date(l).toLocaleDateString()]})}),e.jsx(y,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"p-4 bg-emerald-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Total Transactions"}),e.jsx("p",{className:"text-2xl font-bold text-emerald-700",children:n.count})]}),e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Total Revenue"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-700",children:["PGK ",n.total.toFixed(2)]})]}),e.jsxs("div",{className:"p-4 bg-yellow-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Cash"}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-700",children:["PGK ",n.cash.toFixed(2)]})]}),e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Card"}),e.jsxs("p",{className:"text-2xl font-bold text-purple-700",children:["PGK ",n.card.toFixed(2)]})]}),e.jsxs("div",{className:"p-4 bg-teal-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Other"}),e.jsxs("p",{className:"text-2xl font-bold text-teal-700",children:["PGK ",(n.bankTransfer+n.eftpos).toFixed(2)]})]})]})})]}),e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-emerald-600"}),"Cash Denomination Count"]})}),e.jsxs(y,{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"font-semibold text-slate-700",children:"Notes"}),e.jsx(d,{label:"K 100",value:i.hundred,onChange:t=>o("hundred",t),denomination:100}),e.jsx(d,{label:"K 50",value:i.fifty,onChange:t=>o("fifty",t),denomination:50}),e.jsx(d,{label:"K 20",value:i.twenty,onChange:t=>o("twenty",t),denomination:20}),e.jsx(d,{label:"K 10",value:i.ten,onChange:t=>o("ten",t),denomination:10}),e.jsx(d,{label:"K 5",value:i.five,onChange:t=>o("five",t),denomination:5}),e.jsx(d,{label:"K 2",value:i.two,onChange:t=>o("two",t),denomination:2}),e.jsx(d,{label:"K 1",value:i.one,onChange:t=>o("one",t),denomination:1})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"font-semibold text-slate-700",children:"Coins"}),e.jsx(d,{label:"50t",value:i.fiftyCents,onChange:t=>o("fiftyCents",t),denomination:.5}),e.jsx(d,{label:"20t",value:i.twentyCents,onChange:t=>o("twentyCents",t),denomination:.2}),e.jsx(d,{label:"10t",value:i.tenCents,onChange:t=>o("tenCents",t),denomination:.1}),e.jsx(d,{label:"5t",value:i.fiveCents,onChange:t=>o("fiveCents",t),denomination:.05})]})]}),e.jsxs("div",{className:"pt-4 border-t mt-4",children:[e.jsx(F,{children:"Notes (Optional)"}),e.jsx(k,{placeholder:"Any discrepancies or notes...",value:P,onChange:t=>G(t.target.value),className:"mt-2"})]})]})]}),e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-emerald-600"}),"Reconciliation Summary"]})}),e.jsxs(y,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-slate-50 rounded",children:[e.jsx("span",{children:"Opening Float:"}),e.jsxs("span",{className:"font-semibold",children:["PGK ",r.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 bg-slate-50 rounded",children:[e.jsx("span",{children:"Expected Cash (Float + Cash Sales):"}),e.jsxs("span",{className:"font-semibold",children:["PGK ",(n.cash+r).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 bg-emerald-50 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Actual Cash Counted:"}),e.jsxs("span",{className:"font-bold text-emerald-700",children:["PGK ",v.toFixed(2)]})]}),e.jsxs("div",{className:`flex justify-between items-center p-4 rounded-lg ${j===0?"bg-green-100 border-green-300":Math.abs(j)<=5?"bg-yellow-100 border-yellow-300":"bg-red-100 border-red-300"} border-2`,children:[e.jsx("span",{className:"font-bold text-lg",children:"Variance:"}),e.jsxs("span",{className:"font-bold text-xl",children:[j>0&&"+",j.toFixed(2)," PGK"]})]}),j!==0&&e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded text-sm text-blue-800",children:[e.jsx(J,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),e.jsx("div",{children:j>0?e.jsxs("p",{children:[e.jsx("strong",{children:"Overage:"})," You have PGK ",j.toFixed(2)," more than expected. Please recount or explain in notes."]}):e.jsxs("p",{children:[e.jsx("strong",{children:"Shortage:"})," You are short by PGK ",Math.abs(j).toFixed(2),". Please recount or explain in notes."]})})]})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(C,{onClick:V,className:"w-full bg-gradient-to-r from-emerald-600 to-teal-600",size:"lg",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),"Submit Reconciliation"]})})]})]})]}),e.jsx(U,{open:H,onOpenChange:_,children:e.jsxs(W,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Reconciliation History"}),e.jsx(ee,{children:"View your past cash reconciliation submissions"})]}),e.jsx("div",{className:"space-y-3",children:R.length===0?e.jsx("p",{className:"text-center text-slate-500 py-8",children:"No reconciliation records found."}):R.map(t=>{var h,u,N;return e.jsx(g,{className:"border",children:e.jsx(y,{className:"p-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"font-semibold",children:new Date(t.reconciliation_date).toLocaleDateString()}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Expected"}),e.jsxs("p",{className:"font-semibold",children:["PGK ",(h=t.expected_cash)==null?void 0:h.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Actual"}),e.jsxs("p",{className:"font-semibold",children:["PGK ",(u=t.actual_cash)==null?void 0:u.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Variance"}),e.jsxs("p",{className:`font-semibold ${t.variance>0?"text-green-600":t.variance<0?"text-red-600":"text-slate-600"}`,children:[t.variance>0&&"+",(N=t.variance)==null?void 0:N.toFixed(2)]})]})]}),t.notes&&e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-slate-500",children:"Notes:"}),e.jsx("p",{className:"text-slate-700",children:t.notes})]})]})})})},t.id)})}),e.jsx(te,{children:e.jsx(C,{onClick:()=>_(!1),children:"Close"})})]})})]})};export{he as default};

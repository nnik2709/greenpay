import{v as Z,u as z,a8 as ee,r as l,j as e,A as se,t as ae,m as w,a9 as $,C as E,a as L,b as V,d as k,I as x,B as f,aa as Q,L as v,x as te,P as le,ab as ne}from"./index-f386841f.js";import{S as re,a as ie,b as ce,c as oe,d as R}from"./select-14269127.js";import{R as de,a as me}from"./radio-group-188719c7.js";import{a as xe,c as he}from"./passportsService-036110f9.js";import{c as ue}from"./individualPurchasesService-44373278.js";import{g as U}from"./paymentModesStorage-3d8fa5db.js";import{V as pe}from"./VoucherPrint-580d5f3f.js";import{S as je}from"./search-0da320f8.js";import{S as Ne}from"./scan-line-463d579a.js";import{H as ge}from"./hash-110faeb3.js";import{G as ve}from"./globe-21edfe06.js";import{U as I}from"./user-806b4eaa.js";import{C as T}from"./calendar-a622c72a.js";import{A as _}from"./arrow-right-7a40180d.js";import{D as H}from"./dollar-sign-54a6a05d.js";import{S as fe}from"./shield-c3edc8ad.js";import{A as q}from"./arrow-left-f0f484f3.js";import{Q as ye}from"./qr-code-f7e195e1.js";const be=({currentStep:r})=>{const i=[{name:"Passport Details",icon:e.jsx(I,{})},{name:"Payment",icon:e.jsx(H,{})},{name:"Voucher",icon:e.jsx(ne,{})}];return e.jsx("div",{className:"flex justify-center items-center mb-12",children:i.map((o,s)=>e.jsxs(ae.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(w.div,{animate:{scale:r===s?1.1:1,backgroundColor:r>=s?"#10b981":"#e2e8f0",color:r>=s?"#ffffff":"#64748b"},transition:{duration:.3},className:"w-12 h-12 rounded-full flex items-center justify-center text-2xl",children:r>s?e.jsx($,{}):o.icon}),e.jsx("p",{className:`mt-2 text-sm font-medium ${r>=s?"text-emerald-600":"text-slate-500"}`,children:o.name})]}),s<i.length-1&&e.jsx(w.div,{className:"flex-1 h-1 mx-4 bg-slate-200",initial:!1,animate:{background:`linear-gradient(to right, #10b981 ${r>s?100:0}%, #e2e8f0 ${r>s?100:0}%)`},transition:{duration:.3,delay:.2}})]},s))})},Ce=({onNext:r,setPassportInfo:i,passportInfo:o})=>{const{toast:s}=z(),[h,c]=l.useState(""),[N,m]=l.useState(""),[b,u]=l.useState(null),C=()=>{if(!h.trim()){s({variant:"destructive",title:"Search is empty",description:"Please enter a passport number."});return}const t=mockPassports.find(d=>d.passportNumber.toLowerCase()===h.toLowerCase());t?(u(t),i(t),s({title:"Passport Found",description:`${t.givenName} ${t.surname}'s details have been loaded.`})):(u(null),s({variant:"destructive",title:"Not Found",description:"No passport found with that number."}))},g=l.useCallback(t=>{const d=mockPassports.find(a=>a.passportNumber.toLowerCase()===t.toLowerCase());d?(u(d),i(d),c(d.passportNumber),s({title:"Passport Scanned & Found",description:`${d.givenName} ${d.surname}'s details have been loaded.`})):s({variant:"destructive",title:"Scan Failed",description:"No passport found for the scanned code."}),m("")},[i,s]);l.useEffect(()=>{const t=d=>{const a=(d.clipboardData||window.clipboardData).getData("text");a.length>5&&(m(a.trim()),g(a.trim()))};return window.addEventListener("paste",t),()=>window.removeEventListener("paste",t)},[g]);const p=t=>{const{name:d,value:a}=t.target;i(j=>({...j,[d]:a}))},y=t=>{i(d=>({...d,sex:t}))},P=t=>{const{name:d,files:a}=t.target;a.length>0&&i(j=>({...j,[d]:a[0].name}))};return e.jsxs(w.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:[e.jsxs(E,{className:"overflow-visible",children:[e.jsx(L,{children:e.jsx(V,{children:"Find or Create Passport"})}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold text-slate-700",children:"Search Passport"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(je,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"}),e.jsx(x,{placeholder:"Enter Passport Number",className:"pl-10",value:h,onChange:t=>c(t.target.value)})]})]}),e.jsx(f,{onClick:C,className:"w-full md:w-auto",children:"Search"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"Or Scan with KB Scanner"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold text-slate-700",children:"Scan Passport"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"}),e.jsx(x,{placeholder:"Ready to scan... (or paste here)",className:"pl-10",value:N,onChange:t=>m(t.target.value),onBlur:()=>N&&g(N)})]})]})]})]}),e.jsxs(E,{className:"mt-8",children:[e.jsx(L,{children:e.jsx(V,{children:"Passport Details"})}),e.jsx(k,{children:e.jsxs("form",{onSubmit:t=>t.preventDefault(),className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"passportNumber",children:"Passport Number"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(x,{id:"passportNumber",name:"passportNumber",placeholder:"e.g., P1234567",className:"pl-9",value:o.passportNumber||"",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"nationality",children:"Nationality"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(ve,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(x,{id:"nationality",name:"nationality",placeholder:"e.g., Australian",className:"pl-9",value:o.nationality||"",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"surname",children:"Surname"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(I,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(x,{id:"surname",name:"surname",placeholder:"e.g., Smith",className:"pl-9",value:o.surname||"",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"givenName",children:"Given Name"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(I,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(x,{id:"givenName",name:"givenName",placeholder:"e.g., John",className:"pl-9",value:o.givenName||"",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"dob",children:"Date of Birth"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(x,{id:"dob",name:"dob",type:"date",placeholder:"dd/mm/yyyy",className:"pl-9",value:o.dob||"",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sex",children:"Sex"}),e.jsxs(re,{name:"sex",onValueChange:y,value:o.sex||"",children:[e.jsx(ie,{className:"mt-1",children:e.jsx(ce,{placeholder:"Select sex"})}),e.jsxs(oe,{children:[e.jsx(R,{value:"Male",children:"Male"}),e.jsx(R,{value:"Female",children:"Female"}),e.jsx(R,{value:"Other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"dateOfExpiry",children:"Passport Expiry Date"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(x,{id:"dateOfExpiry",name:"dateOfExpiry",type:"date",placeholder:"dd/mm/yyyy",className:"pl-9",value:o.dateOfExpiry||"",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Passport Photo"}),e.jsxs("div",{className:"mt-1 flex items-center gap-3 rounded-lg border p-3",children:[e.jsxs(f,{type:"button",variant:"outline",onClick:()=>document.getElementById("passportPhoto").click(),children:[e.jsx(Q,{className:"w-4 h-4 mr-2"})," Choose file"]}),e.jsx(x,{id:"passportPhoto",name:"passportPhoto",type:"file",className:"hidden",onChange:P}),e.jsx("span",{className:"text-sm text-slate-500",children:o.passportPhoto||"No file chosen"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Signature Image"}),e.jsxs("div",{className:"mt-1 flex items-center gap-3 rounded-lg border p-3",children:[e.jsxs(f,{type:"button",variant:"outline",onClick:()=>document.getElementById("signatureImage").click(),children:[e.jsx(Q,{className:"w-4 h-4 mr-2"})," Choose file"]}),e.jsx(x,{id:"signatureImage",name:"signatureImage",type:"file",className:"hidden",onChange:P}),e.jsx("span",{className:"text-sm text-slate-500",children:o.signatureImage||"No file chosen"})]})]})]})})]}),e.jsx("div",{className:"flex justify-end mt-8",children:e.jsxs(f,{onClick:r,size:"lg",children:["Proceed to Payment ",e.jsx(_,{className:"ml-2 w-5 h-5"})]})})]})},Pe=({onNext:r,onBack:i,passportInfo:o,setPaymentData:s})=>{const{toast:h}=z(),[c,N]=l.useState([]),[m,b]=l.useState(""),[u,C]=l.useState(50),[g,p]=l.useState(0),[y,P]=l.useState(50),[t,d]=l.useState(""),[a,j]=l.useState(""),[S,Y]=l.useState(""),[B,K]=l.useState(!1);l.useEffect(()=>{(async()=>{const M=(await U()).filter(F=>F.active);N(M),M.length>0&&b(M[0].name)})()},[]),l.useEffect(()=>{const n=()=>{document.hidden||(async()=>{const F=(await U()).filter(X=>X.active);N(F),F.length>0&&!m&&b(F[0].name)})()};return document.addEventListener("visibilitychange",n),()=>document.removeEventListener("visibilitychange",n)},[m]);const D=u-u*(g/100),A=y-D,G=c.find(n=>n.name===m),O=G==null?void 0:G.collectCardDetails,J=async()=>{if(!m){h({variant:"destructive",title:"No Payment Mode",description:"Please select a payment mode."});return}if(y<D){h({variant:"destructive",title:"Insufficient Amount",description:"Collected amount is less than the total."});return}if(O&&(!t||!a||!S)){h({variant:"destructive",title:"Card Details Required",description:"Please enter all card details."});return}K(!0),s({paymentMethod:m,amount:D,discount:g,collectedAmount:y,returnedAmount:A>0?A:0,cardLastFour:O?t.slice(-4):null}),h({title:"Payment Accepted",description:`Payment of PGK ${D.toFixed(2)} processed successfully.`}),setTimeout(()=>{K(!1),r()},800)};return e.jsxs(w.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:[e.jsxs(E,{children:[e.jsx(L,{children:e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-6 h-6"}),"Payment Details"]})}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Total Amount (PGK)"}),e.jsx(x,{type:"number",value:u,onChange:n=>C(parseFloat(n.target.value)||0),className:"font-bold"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Discount (%)"}),e.jsx(x,{type:"number",value:g,onChange:n=>p(parseFloat(n.target.value)||0)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Amount After Discount"}),e.jsx(x,{value:D.toFixed(2),readOnly:!0,className:"bg-slate-100 font-bold"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Collected Amount (PGK)"}),e.jsx(x,{type:"number",value:y,onChange:n=>P(parseFloat(n.target.value)||0)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Change/Returned Amount"}),e.jsx(x,{value:A>0?A.toFixed(2):"0.00",readOnly:!0,className:"bg-slate-100"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(v,{className:"text-base font-semibold",children:"Payment Method"}),e.jsx(de,{value:m,onValueChange:b,className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:c.map(n=>e.jsxs("div",{className:"flex items-center space-x-2 border rounded-lg p-3 hover:bg-slate-50",children:[e.jsx(me,{value:n.name,id:n.name}),e.jsx(v,{htmlFor:n.name,className:"font-normal cursor-pointer flex-1",children:n.name})]},n.id))})]}),O&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsx("h3",{className:"font-semibold text-slate-700",children:"Card Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Card Number"}),e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"}),e.jsx(x,{placeholder:"0000 0000 0000 0000",className:"pl-10",value:t,onChange:n=>d(n.target.value),maxLength:19})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Expiry Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"}),e.jsx(x,{placeholder:"MM/YY",className:"pl-10",value:a,onChange:n=>j(n.target.value),maxLength:5})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"CVC"}),e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"}),e.jsx(x,{placeholder:"123",className:"pl-10",value:S,onChange:n=>Y(n.target.value),maxLength:4,type:"password"})]})]})]})]})]})]}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsxs(f,{onClick:i,variant:"outline",size:"lg",disabled:B,children:[e.jsx(q,{className:"mr-2 w-5 h-5"})," Back"]}),e.jsxs(f,{onClick:J,size:"lg",disabled:B,className:"bg-gradient-to-r from-emerald-500 to-teal-600",children:[B?"Processing...":"Process Payment"," ",e.jsx(_,{className:"ml-2 w-5 h-5"})]})]})]})},we=({onBack:r,passportInfo:i,paymentData:o,voucher:s})=>{const[h,c]=l.useState(!1);return s?e.jsxs(w.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:[e.jsxs(E,{className:"border-green-200",children:[e.jsx(L,{className:"bg-green-50",children:e.jsxs(V,{className:"flex items-center gap-2 text-green-700",children:[e.jsx($,{className:"w-6 h-6"}),"Voucher Generated Successfully!"]})}),e.jsxs(k,{className:"p-6 space-y-6",children:[e.jsx("div",{className:"bg-green-100 border border-green-300 rounded-lg p-4",children:e.jsxs("p",{className:"text-green-800 font-semibold",children:["Exit pass voucher has been created for ",i.givenName," ",i.surname]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-slate-700 border-b pb-2",children:"Passport Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Passport Number:"}),e.jsx("span",{className:"font-semibold",children:s.passport_number})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Name:"}),e.jsxs("span",{className:"font-semibold",children:[i.givenName," ",i.surname]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Nationality:"}),e.jsx("span",{className:"font-semibold",children:i.nationality})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-slate-700 border-b pb-2",children:"Voucher Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Voucher Code:"}),e.jsx("span",{className:"font-mono font-bold text-green-600",children:s.voucher_code})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Amount:"}),e.jsxs("span",{className:"font-semibold",children:["PGK ",s.amount]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Payment Method:"}),e.jsx("span",{className:"font-semibold",children:s.payment_method})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Valid Until:"}),e.jsx("span",{className:"font-semibold",children:new Date(s.valid_until).toLocaleDateString()})]})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4 border-t",children:[e.jsxs(f,{onClick:()=>c(!0),className:"flex-1 bg-emerald-600 hover:bg-emerald-700",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Print Voucher"]}),e.jsxs(f,{variant:"outline",className:"flex-1",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Show QR Code"]})]})]})]}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsxs(f,{onClick:r,variant:"outline",size:"lg",children:[e.jsx(q,{className:"mr-2 w-5 h-5"})," Create Another"]}),e.jsxs(f,{onClick:()=>window.location.href="/",size:"lg",className:"bg-gradient-to-r from-emerald-500 to-teal-600",children:[e.jsx($,{className:"mr-2 w-5 h-5"})," Done"]})]}),e.jsx(pe,{voucher:s,isOpen:h,onClose:()=>c(!1),voucherType:"Individual"})]}):e.jsx(w.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:e.jsx(E,{children:e.jsx(k,{className:"py-16 text-center",children:e.jsx("p",{className:"text-slate-500",children:"Generating voucher..."})})})})},Qe=()=>{const{user:r}=Z(),{toast:i}=z(),o=ee(),[s,h]=l.useState(0),[c,N]=l.useState({}),[m,b]=l.useState(null),[u,C]=l.useState(null),[g,p]=l.useState(!1);l.useEffect(()=>{var a,j;(a=o.state)!=null&&a.prefillData&&((j=o.state)!=null&&j.fromScan)&&(N(o.state.prefillData),i({title:"Passport Data Loaded",description:`Scanned data for ${o.state.prefillData.givenName} ${o.state.prefillData.surname} has been loaded.`}))},[o.state,i]);const y=()=>h(a=>Math.min(a+1,2)),P=()=>h(a=>Math.max(a-1,0));l.useEffect(()=>{s===2&&m&&!u&&!g&&t()},[s,m,u,g]);const t=async()=>{p(!0);try{console.log("Starting voucher creation..."),console.log("Passport info:",c),console.log("Payment data:",m),console.log("User:",r);let a=await xe(c.passportNumber);console.log("Found passport:",a),a||(console.log("Creating new passport..."),a=await he({passportNumber:c.passportNumber,nationality:c.nationality,surname:c.surname,givenName:c.givenName,dob:c.dob,sex:c.sex,dateOfExpiry:c.dateOfExpiry},r==null?void 0:r.id),console.log("Created passport:",a));const j={passportId:a.id,passportNumber:a.passport_number,amount:m.amount,paymentMethod:m.paymentMethod,cardLastFour:m.cardLastFour,nationality:a.nationality};console.log("Purchase data:",j);const S=await ue(j,r==null?void 0:r.id);console.log("Created voucher:",S),C(S),i({title:"Success!",description:"Voucher generated successfully."})}catch(a){console.error("Error creating voucher:",a),console.error("Error details:",{message:a.message,stack:a.stack,passportInfo:c,paymentData:m,user:r}),i({variant:"destructive",title:"Error",description:`Failed to generate voucher: ${a.message||"Please try again."}`}),h(1)}finally{p(!1)}},d=()=>{h(0),N({}),b(null),C(null)};return e.jsxs("div",{className:"max-w-5xl mx-auto p-4 sm:p-6 lg:p-8",children:[e.jsx(be,{currentStep:s}),e.jsxs(se,{mode:"wait",children:[s===0&&e.jsx(Ce,{onNext:y,setPassportInfo:N,passportInfo:c},"step0"),s===1&&e.jsx(Pe,{onNext:y,onBack:P,passportInfo:c,setPaymentData:b},"step1"),s===2&&e.jsx(we,{onBack:d,passportInfo:c,paymentData:m,voucher:u},"step2")]})]})};export{Qe as default};

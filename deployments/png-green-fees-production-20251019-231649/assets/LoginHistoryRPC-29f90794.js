import{p as E,q as V,a8 as O,h as Z,u as A,r as a,s as D,j as e,B as G,C as n,d as c,I as S,a as J,b as K,m as X}from"./index-f386841f.js";import{S as Y,a as ee,b as se,c as te,d as k}from"./select-14269127.js";import{E as ae}from"./ExportButton-bbdea4ab.js";import{A as re}from"./arrow-left-f0f484f3.js";import{C as le}from"./calendar-a622c72a.js";import{C}from"./clock-24cb648f.js";import{U as L}from"./user-806b4eaa.js";import{S as ie}from"./search-0da320f8.js";import"./xlsx-f5126985.js";import"./file-spreadsheet-279cbcb4.js";const ne=E("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),U=E("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]),pe=()=>{const{userId:m}=V(),o=O(),F=Z(),{toast:I}=A(),[p,T]=a.useState([]),[r,M]=a.useState([]),[P,N]=a.useState(!0),[h,q]=a.useState(""),[d,g]=a.useState("all"),[u,B]=a.useState(""),[H,W]=a.useState([]),[i,v]=a.useState("");a.useEffect(()=>{var s,t;R(),$(),(s=o.state)!=null&&s.userFilter?(g(o.state.userFilter),v(o.state.userName||"")):m&&(g(m),v(((t=o.state)==null?void 0:t.userName)||""))},[o.state,m]),a.useEffect(()=>{z()},[p,h,d,u]);const R=async()=>{try{N(!0);const{data:s,error:t}=await D.rpc("get_login_history",{p_user_id:m||null});if(t)throw t;T(s||[])}catch(s){console.error("Error fetching login events:",s),I({title:"Error",description:"Failed to load login history",variant:"destructive"})}finally{N(!1)}},$=async()=>{try{const{data:s,error:t}=await D.rpc("get_all_users");if(t)throw t;W(s||[])}catch(s){console.error("Error fetching users:",s)}},z=()=>{let s=[...p];if(h){const t=h.toLowerCase();s=s.filter(l=>{var j,x,_;return((j=l.user_email)==null?void 0:j.toLowerCase().includes(t))||((x=l.ip_address)==null?void 0:x.toLowerCase().includes(t))||((_=l.user_agent)==null?void 0:_.toLowerCase().includes(t))})}if(d&&d!=="all"&&(s=s.filter(t=>t.user_id===d)),u){const t=new Date(u),l=new Date(t);l.setDate(l.getDate()+1),s=s.filter(j=>{const x=new Date(j.login_time);return x>=t&&x<l})}M(s)},y=s=>s==="127.0.0.1"||s==="::1"||s!=null&&s.startsWith("192.168.")||s!=null&&s.startsWith("10.")?"Local Network":s||"Unknown",w=s=>s?s.includes("Chrome")?"Chrome":s.includes("Firefox")?"Firefox":s.includes("Safari")?"Safari":s.includes("Edge")?"Edge":"Other":"Unknown",b=s=>s?s.includes("Mobile")?"Mobile":s.includes("Tablet")?"Tablet":"Desktop":"Unknown",Q=[{name:"Date",selector:s=>new Date(s.login_time).toLocaleString()},{name:"User Email",selector:s=>s.user_email||"Unknown"},{name:"IP Address",selector:s=>s.ip_address||"Unknown"},{name:"Location",selector:s=>y(s.ip_address)},{name:"Browser",selector:s=>w(s.user_agent)},{name:"Device",selector:s=>b(s.user_agent)},{name:"Event Type",selector:s=>s.event_type||"login"}],f={total:r.length,today:r.filter(s=>{const t=new Date;return new Date(s.login_time).toDateString()===t.toDateString()}).length,thisWeek:r.filter(s=>{const t=new Date;return t.setDate(t.getDate()-7),new Date(s.login_time)>=t}).length,uniqueUsers:new Set(r.map(s=>s.user_id)).size};return P?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(G,{variant:"outline",size:"sm",onClick:()=>F("/users"),className:"text-slate-600 hover:text-slate-800",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"Back to Users"]}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent",children:["Login History",i&&e.jsxs("span",{className:"text-lg font-normal text-slate-600 ml-2",children:["for ",i]})]}),e.jsx("p",{className:"text-slate-600 mt-1",children:i?`Login activity for ${i}`:"Monitor user login activity and security events"})]})]}),e.jsx(ae,{data:r,columns:Q,filename:`Login_History_Report${i?`_${i}`:""}`,title:"Login History Report"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(n,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-emerald-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total Logins"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:f.total})]})]})})}),e.jsx(n,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Today"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:f.today})]})]})})}),e.jsx(n,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-5 h-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"This Week"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:f.thisWeek})]})]})})}),e.jsx(n,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Unique Users"}),e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:f.uniqueUsers})]})]})})})]}),e.jsx(n,{children:e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(S,{placeholder:"Search by email, IP, or browser...",className:"pl-10",value:h,onChange:s=>q(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"User"}),e.jsxs(Y,{value:d,onValueChange:g,children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"All users"})}),e.jsxs(te,{children:[e.jsx(k,{value:"all",children:"All users"}),H.map(s=>e.jsx(k,{value:s.id,children:s.email},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Date"}),e.jsx(S,{type:"date",value:u,onChange:s=>B(s.target.value)})]})]})})}),e.jsxs(n,{children:[e.jsx(J,{children:e.jsxs(K,{children:["Login Events (",r.length," records)"]})}),e.jsx(c,{children:r.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"No login events found matching your criteria."}):e.jsx("div",{className:"space-y-4",children:r.map((s,t)=>e.jsx(X.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:t*.05},className:"border border-slate-200 rounded-lg p-4 hover:bg-slate-50 transition-colors",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center",children:e.jsx(L,{className:"w-4 h-4 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-800",children:s.user_email||"Unknown User"}),e.jsxs("p",{className:"text-sm text-slate-500",children:[s.event_type||"login"," â€¢ ",s.ip_address||"No IP"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{children:new Date(s.login_time).toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{children:y(s.ip_address)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{children:[w(s.user_agent)," on ",b(s.user_agent)]})]})]})]})})},s.id))})})]})]})};export{pe as default};
